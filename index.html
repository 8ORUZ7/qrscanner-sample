<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Code Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    color-scheme: light dark;
    --bg:#0f172a; --panel:#1e293b; --accent:#2563eb;
    --ok:#16a34a; --err:#dc2626; --warn:#d97706; --focus:#93c5fd;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;min-height:100svh;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(circle at 30% 20%,#1e293b,#0f172a 70%);
    color:#f1f5f9;padding:1.25rem;
  }
  main{width:100%;max-width:560px;display:flex;flex-direction:column;gap:1rem;text-align:center;}
  h1{margin:0 0 .45rem;font-size:clamp(1.55rem,4.5vw,2.4rem);letter-spacing:.5px;}
  .step-indicator{font-size:.7rem;letter-spacing:.55px;text-transform:uppercase;opacity:.75;min-height:1rem;}

  /* Scanner (Step 1) */
  .scanner-shell{
    position:relative;width:100%;max-width:520px;aspect-ratio:1/1;
    background:#000;border:2px solid #334155;border-radius:1rem;overflow:hidden;
    margin:0 auto;display:none;align-items:center;justify-content:center;
  }
  .scanner-shell.active{display:flex;}
  video{
    width:100%;height:100%;object-fit:cover;transform:scaleX(-1);
  }
  #scanVideo{display:none;}
  #selfieVideo{display:none;}
  canvas{
    position:absolute;inset:0;width:100%;height:100%;pointer-events:none;
    opacity:0;transition:opacity .18s ease;
  }
  .overlay{position:absolute;inset:0;pointer-events:none;}
  .overlay::before{
    content:"";position:absolute;inset:0;
    background:radial-gradient(circle at center,rgba(0,0,0,0) 60%,rgba(0,0,0,.55) 82%);
  }
  .frame-corner{
    position:absolute;width:2.3rem;height:2.3rem;border:4px solid var(--accent);
    filter:drop-shadow(0 0 4px var(--accent));
  }
  .frame-corner.tl{top:10%;left:10%;border-right:0;border-bottom:0;}
  .frame-corner.tr{top:10%;right:10%;border-left:0;border-bottom:0;}
  .frame-corner.bl{bottom:10%;left:10%;border-right:0;border-top:0;}
  .frame-corner.br{bottom:10%;right:10%;border-left:0;border-top:0;}
  #placeholderMsg{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:.9rem;opacity:.75;padding:1rem;text-align:center;
  }

  button{
    font:inherit;padding:.8rem 1.2rem;border-radius:.85rem;border:1px solid #475569;
    background:linear-gradient(#2563eb,#1d4ed8);color:#fff;font-weight:600;letter-spacing:.45px;
    cursor:pointer;transition:background .25s,transform .15s;
  }
  button:hover:not(:disabled){background:linear-gradient(#3b82f6,#2563eb);}
  button:focus-visible{outline:3px solid var(--focus);outline-offset:2px;}
  button:active:not(:disabled){transform:translateY(2px);}
  button:disabled{opacity:.55;cursor:not-allowed;}

  .badge{padding:.3rem .7rem;border-radius:1rem;background:#334155;font-weight:500;font-size:.65rem;}
  .badge.ok{background:var(--ok);color:#fff;}
  .badge.err{background:var(--err);color:#fff;}
  .badge.warn{background:var(--warn);color:#fff;}

  .status{min-height:1.2rem;display:flex;gap:.45rem;justify-content:center;flex-wrap:wrap;}

  .panel{
    background:var(--panel);padding:1rem 1.15rem;border:1px solid #334155;border-radius:1rem;
    font-size:.9rem;text-align:left;word-break:break-word;display:none;
  }
  .panel.centered{text-align:center;}

  .greeting-msg{font-size:1.35rem;margin:.3rem 0 .55rem;font-weight:760;letter-spacing:.65px;}

  /* Selfie section (Step 3) */
  #selfieContainer{
    display:none;
    background:var(--panel);
    border:1px solid #334155;
    border-radius:1rem;
    padding:1rem 1rem 1.4rem;
  }
  #selfieHeader{font-size:.8rem;letter-spacing:.5px;opacity:.7;margin:0 0 .6rem;}
  #selfieLiveWrapper{
    position:relative;width:100%;max-width:520px;aspect-ratio:1/1;
    background:#000;border:2px solid #334155;border-radius:1rem;
    overflow:hidden;margin:0 auto .65rem;
  }
  #selfieVideo{display:block;}
  #selfiePreview{
    max-width:100%;border-radius:.85rem;border:2px solid #334155;display:none;margin-top:.4rem;
  }
  .selfie-actions{display:flex;gap:.65rem;flex-wrap:wrap;justify-content:center;margin-top:.75rem;}
  .note{font-size:.63rem;opacity:.6;margin-top:.55rem;}

  .entry-wrapper{
    display:none;
    background:var(--panel);
    border:2px solid var(--ok);
    border-radius:1.1rem;
    padding:2.2rem 1.2rem 2.6rem;
    box-shadow:0 0 0 2px #16a34a55,0 8px 30px -10px #16a34acc;
    animation:fadeIn .45s ease;
  }
  .entry-msg{
    font-size:1.95rem;
    margin:0 0 .9rem;
    font-weight:850;
    letter-spacing:1px;
    color:var(--ok);
  }
  .countdown{font-size:.8rem;opacity:.85;margin:0;}
  @keyframes fadeIn{from{opacity:0;transform:scale(.96);}to{opacity:1;transform:scale(1);}}
  .pulse{animation:pulse 1.15s ease-in-out 2;}
  @keyframes pulse{0%{transform:scale(1);}40%{transform:scale(1.045);}100%{transform:scale(1);}}

  .method-indicator{font-size:.55rem;opacity:.55;min-height:.75rem;}
  .hidden{display:none !important;}
  a.inline-reset{color:var(--accent);cursor:pointer;font-size:.65rem;text-decoration:none;margin-left:.45rem;}
  a.inline-reset:hover{text-decoration:underline;}

  footer{margin-top:.9rem;font-size:.6rem;opacity:.55;}
</style>
</head>
<body>
<main>
  <h1>QR Scanner</h1>
  <div id="currentStep" class="step-indicator">Step 1: Ready</div>

  <!-- STEP 1: Scanner -->
  <div class="scanner-shell" id="scannerShell" aria-label="QR scanner viewport">
    <video id="scanVideo" playsinline muted></video>
    <canvas id="scanCanvas" aria-hidden="true"></canvas>
    <div class="overlay" aria-hidden="true">
      <div class="frame-corner tl"></div>
      <div class="frame-corner tr"></div>
      <div class="frame-corner bl"></div>
      <div class="frame-corner br"></div>
    </div>
    <div id="placeholderMsg">Tap Start Scan.</div>
  </div>

  <!-- Start Button (only interactive button at beginning) -->
  <div>
    <button id="startBtn" type="button">Start Scan</button>
  </div>

  <div class="status"><span class="badge" id="envBadge">Idle</span></div>
  <div class="method-indicator" id="methodIndicator"></div>

  <!-- STEP 2: Greeting -->
  <section class="panel centered" id="greetingPanel" aria-live="assertive">
    <div style="font-size:.65rem;opacity:.65;margin:0 0 .35rem;">Step 2: Greeting</div>
    <p class="greeting-msg" id="greetingMsg"></p>
    <p id="greetingMeta" style="margin:0;font-size:.65rem;opacity:.65;"></p>
  </section>

  <!-- STEP 3: Selfie (has its own live preview distinct from scanner) -->
  <section id="selfieContainer" aria-label="Selfie verification">
    <h2 id="selfieHeader">Step 3: Selfie Verification</h2>
    <div id="selfieLiveWrapper">
      <video id="selfieVideo" playsinline muted></video>
      <div style="position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at center,rgba(0,0,0,0) 55%,rgba(0,0,0,.45) 87%);"></div>
    </div>
    <p id="selfieInstruction" style="margin:.2rem 0 .55rem;font-size:.8rem;opacity:.9;">Please take a selfie to continue.</p>
    <img id="selfiePreview" alt="Selfie preview" />
    <div class="selfie-actions">
      <button id="captureBtn" type="button" disabled>Capture Selfie</button>
      <button id="retakeBtn" type="button" disabled>Retake</button>
      <button id="submitSelfieBtn" type="button" disabled>Submit</button>
    </div>
    <p class="note">Selfie is never uploaded (kept only in memory).</p>
  </section>

  <!-- STEP 4: Entry (only message visible) -->
  <div id="entryPanel" class="entry-wrapper" aria-live="polite">
    <p class="entry-msg">PLEASE COME IN!</p>
    <p id="resetCountdown" class="countdown"></p>
  </div>

  <footer>Sequence: Scan → Greeting → Selfie (new live preview) → Entry (60s auto reset)</footer>
</main>

<!-- jsQR (fallback) -->
<script defer src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"
 integrity="sha384-rC5NcI3F9zeJq82cC28hvMmjr4neTJD7sPXQf8zl9uG6MS5Icnvx8e3UgFF3Rdg6"
 crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
;(() => {
  "use strict";

  /**************** CONFIG ****************/
  const USER_CODES = {
    "3OE0C1KD":"JOHN SMITH",
    "CKR9WLDM":"JANE DOE"
  };
  const AUTO_RESET_MS = 60000;
  const THROTTLE_MS = 900;
  /****************************************/

  const els = {
    step: document.getElementById('currentStep'),
    startBtn: document.getElementById('startBtn'),
    envBadge: document.getElementById('envBadge'),
    methodIndicator: document.getElementById('methodIndicator'),

    // Step 1
    scannerShell: document.getElementById('scannerShell'),
    scanVideo: document.getElementById('scanVideo'),
    scanCanvas: document.getElementById('scanCanvas'),
    placeholder: document.getElementById('placeholderMsg'),
    startbutton: document.getElementById('startBtn'),
    status: document.getElementById('status'),

    // Step 2
    greetingPanel: document.getElementById('greetingPanel'),
    greetingMsg: document.getElementById('greetingMsg'),
    greetingMeta: document.getElementById('greetingMeta'),

    // Step 3
    selfieContainer: document.getElementById('selfieContainer'),
    selfieVideo: document.getElementById('selfieVideo'),
    selfieInstruction: document.getElementById('selfieInstruction'),
    selfiePreview: document.getElementById('selfiePreview'),
    captureBtn: document.getElementById('captureBtn'),
    retakeBtn: document.getElementById('retakeBtn'),
    submitSelfieBtn: document.getElementById('submitSelfieBtn'),

    // Step 4
    entryPanel: document.getElementById('entryPanel'),
    resetCountdown: document.getElementById('resetCountdown')
  };

  const state = {
    scanStream:null,
    selfieStream:null,
    detector:null,
    decodeMode:'auto',
    running:false,
    scanning:false,
    lastValue:null,
    lastScanTs:0,
    rafId:null,
    countdownTimer:null,
    resetTimer:null,
    countdownRemaining:0,
    selfieStage:'idle', // idle|awaiting|captured|completed
    selfieData:null
  };

  const setBadge = (t,l) => {
    els.envBadge.textContent = t;
    els.envBadge.className = 'badge' + (l ? ' '+l : '');
  };
  const setStep = t => els.step.textContent = t;

  /*********** Step 1: Scanner ***********/
  async function initDetector() {
    if ('BarcodeDetector' in window) {
      try {
        const fmts = await BarcodeDetector.getSupportedFormats();
        if (fmts.includes('qr_code')) {
          state.detector = new BarcodeDetector({formats:['qr_code']});
          state.decodeMode='barcode';
          setBadge('Ready (BarcodeDetector)','ok');
          return;
        }
      } catch(e){ console.warn('BarcodeDetector failed', e); }
    }
    state.decodeMode='jsQR';
    setBadge('Ready (jsQR)','warn');
  }

  async function startScan() {
    resetAll(); // ensure clean
    setStep('Starting camera');
    try {
      state.scanStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:1280}, aspectRatio:1 },
        audio:false
      });
    } catch(e) {
      console.error(e);
      if (location.protocol !== 'https:') alert('Camera requires HTTPS (or localhost).');
      setBadge('Camera denied','err');
      setStep('Camera error');
      return;
    }
    els.scannerShell.classList.add('active');
    els.scanVideo.srcObject = state.scanStream;
    await els.scanVideo.play();
    els.scanVideo.style.display='block';
    els.placeholder.style.display='none';
    els.startbutton.style.display='none';
    els.status.style.display='none';
    els.startBtn.disabled=true;
    state.running=true;
    setBadge('Scanning ('+state.decodeMode+')','ok');
    setStep('Scanning');
    loop();
  }

  function loop() {
    if (!state.running) return;
    state.rafId = requestAnimationFrame(loop);
    if (state.scanning) return;
    state.scanning = true;

    if (state.detector && state.decodeMode === 'barcode') {
      state.detector.detect(els.scanVideo)
        .then(codes=>{
          if (codes && codes.length) {
            handleScanResult(codes[0].rawValue,{source:'BarcodeDetector'});
          } else {
            tryJsQR().finally(()=> state.scanning=false);
          }
        })
        .catch(()=>{
          state.decodeMode='jsQR';
          setBadge('Fallback jsQR','warn');
          tryJsQR().finally(()=> state.scanning=false);
        });
    } else {
      tryJsQR().finally(()=> state.scanning=false);
    }
  }

  function tryJsQR() {
    return new Promise(resolve=>{
      if (!window.jsQR) return resolve();
      const ctx = els.scanCanvas.getContext('2d',{willReadFrequently:true});
      const v = els.scanVideo;
      const vw=v.videoWidth, vh=v.videoHeight;
      if (!vw || !vh) return resolve();
      const side = Math.min(vw,vh);
      const sx=(vw-side)/2, sy=(vh-side)/2;
      els.scanCanvas.width=side; els.scanCanvas.height=side;
      ctx.drawImage(v,sx,sy,side,side,0,0,side,side);
      const img = ctx.getImageData(0,0,side,side);
      const qr = jsQR(img.data,img.width,img.height,{inversionAttempts:'attemptBoth'});
      if (qr) handleScanResult(qr.data,{source:'jsQR',location:qr.location});
      resolve();
    });
  }

  function handleScanResult(raw, meta) {
    const value=(''+raw).trim();
    if (!value) return;
    const now=performance.now();
    if (value===state.lastValue && (now - state.lastScanTs) < THROTTLE_MS) return;
    state.lastValue=value;
    state.lastScanTs=now;
    els.methodIndicator.textContent='Decoded via: '+(meta.source||'unknown');
    highlight(meta.location);

    const code=value.toUpperCase();
    const name=USER_CODES[code];
    if (!name) return;

    // Stop scanning entirely
    state.running=false;
    cancelAnimationFrame(state.rafId);
    stopScanStream();

    // Hide scanner
    els.scannerShell.classList.remove('active');
    els.scannerShell.style.display='none';

    // Step 2: Greeting
    showGreeting(name, code);

    // Immediately move to Step 3 (selfie) with a NEW camera stream
    setTimeout(()=> startSelfie(name), 400);
  }

  function highlight(location){
    const ctx=els.scanCanvas.getContext('2d');
    ctx.clearRect(0,0,els.scanCanvas.width,els.scanCanvas.height);
    if (!location){ flashCanvas(); return; }
    ctx.save();
    ctx.strokeStyle='#16a34a'; ctx.lineWidth=3;
    const pts=[location.topLeftCorner,location.topRightCorner,location.bottomRightCorner,location.bottomLeftCorner];
    if (pts.every(Boolean)){
      ctx.beginPath();
      pts.forEach((p,i)=> i? ctx.lineTo(p.x,p.y) : ctx.moveTo(p.x,p.y));
      ctx.closePath();
      ctx.stroke();
    }
    ctx.restore();
    flashCanvas();
  }
  function flashCanvas(){
    els.scanCanvas.style.opacity=.9;
    setTimeout(()=>els.scanCanvas.style.opacity=0,220);
  }

  function stopScanStream(){
    if (state.scanStream){
      state.scanStream.getTracks().forEach(t=>t.stop());
      state.scanStream=null;
    }
    els.scanVideo.srcObject=null;
    els.scanVideo.style.display='none';
  }

  /*********** Step 2: Greeting ***********/
  function showGreeting(name, code){
    setStep('Greeting');
    els.greetingMsg.textContent = `Welcome Back ${name}!`;
    els.greetingMeta.textContent = `Code: ${code} • ${new Date().toLocaleTimeString()}`;
    els.greetingPanel.style.display='block';
    els.greetingPanel.classList.add('pulse');
    setTimeout(()=>els.greetingPanel.classList.remove('pulse'),1200);
  }

  /*********** Step 3: Selfie ***********/
  async function startSelfie(name){
    setStep('Selfie');
    els.selfieContainer.style.display='block';
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent = `Please take a selfie to continue, ${name}.`;

    // Acquire a NEW stream for selfie preview
    try {
      state.selfieStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:1280}, aspectRatio:1 },
        audio:false
      });
    } catch(e){
      console.error('Selfie camera error', e);
      els.selfieInstruction.textContent='Unable to access camera. Reload and allow permission.';
      return;
    }
    els.selfieVideo.srcObject=state.selfieStream;
    await els.selfieVideo.play();
    els.selfieVideo.style.display='block';
    els.captureBtn.disabled=false;
  }

  function captureSelfie(){
    if (!['awaiting','captured'].includes(state.selfieStage)) return;
    if (!state.selfieStream) return alert('Camera not active.');
    const v=els.selfieVideo, vw=v.videoWidth, vh=v.videoHeight;
    if (!vw || !vh) return;
    const side=Math.min(vw,vh);
    const sx=(vw-side)/2, sy=(vh-side)/2;
    const off=document.createElement('canvas');
    off.width=side; off.height=side;
    off.getContext('2d').drawImage(v,sx,sy,side,side,0,0,side,side);
    state.selfieData=off.toDataURL('image/jpeg',0.9);
    els.selfiePreview.src=state.selfieData;
    els.selfiePreview.style.display='block';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=false;
    els.submitSelfieBtn.disabled=false;
    state.selfieStage='captured';
    els.selfieInstruction.textContent='Review your selfie. Submit or retake.';
  }

  function retakeSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieData=null;
    els.selfiePreview.style.display='none';
    els.captureBtn.disabled=false;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent='Please take a selfie to continue.';
  }

  function submitSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieStage='completed';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Selfie submitted.';
    endSelfieAndShowEntry();
  }

  function endSelfieAndShowEntry(){
    // Stop selfie stream
    if (state.selfieStream){
      state.selfieStream.getTracks().forEach(t=>t.stop());
      state.selfieStream=null;
    }
    els.selfieVideo.srcObject=null;
    els.selfieVideo.style.display='none';

    // Hide everything except entry message
    els.greetingPanel.style.display='none';
    els.selfieContainer.style.display='none';

    showEntry();
  }

  /*********** Step 4: Entry + Reset ***********/
  function showEntry(){
    setStep('Entry');
    els.entryPanel.style.display='block';
    startResetCountdown();
  }

  function startResetCountdown(){
    clearResetTimers();
    state.countdownRemaining = Math.round(AUTO_RESET_MS/1000);
    updateCountdown();
    state.countdownTimer = setInterval(()=>{
      state.countdownRemaining--;
      if (state.countdownRemaining<=0){
        resetAll();
      } else updateCountdown();
    },1000);
    state.resetTimer = setTimeout(resetAll, AUTO_RESET_MS);
  }

  function updateCountdown(){
    els.resetCountdown.innerHTML = `Resetting in ${state.countdownRemaining}s... <a class="inline-reset" id="resetNowLink">(Reset Now)</a>`;
    const link=document.getElementById('resetNowLink');
    if (link) link.onclick = e => { e.preventDefault(); resetAll(); };
  }

  function clearResetTimers(){
    if (state.countdownTimer) clearInterval(state.countdownTimer);
    if (state.resetTimer) clearTimeout(state.resetTimer);
    state.countdownTimer=state.resetTimer=null;
  }

  /*********** Reset All ***********/
  function resetAll(){
    clearResetTimers();

    // Stop any streams
    if (state.scanStream) stopScanStream();
    if (state.selfieStream){
      state.selfieStream.getTracks().forEach(t=>t.stop());
      state.selfieStream=null;
    }
    els.selfieVideo.srcObject=null;
    els.selfieVideo.style.display='none';

    // Hide panels and sections
    els.scannerShell.classList.remove('active');
    els.scannerShell.style.display=''; // keep available but hidden by absence of 'active'
    els.placeholder.style.display='flex';
    els.greetingPanel.style.display='none';
    els.selfieContainer.style.display='none';
    els.entryPanel.style.display='none';
    els.selfiePreview.style.display='none';

    // Reset controls
    els.startBtn.disabled=false;
    els.startBtn.classList.remove('hidden');
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Please take a selfie to continue.';
    els.methodIndicator.textContent='';

    // State
    state.running=false;
    state.scanning=false;
    state.lastValue=null;
    state.selfieStage='idle';
    state.selfieData=null;

    setBadge('Idle');
    setStep('Ready');
  }

  /*********** Visibility / Privacy ***********/
  document.addEventListener('visibilitychange',()=>{
    if (document.hidden){
      // Stop active streams for privacy, user can restart
      if (state.scanStream) stopScanStream();
      if (state.selfieStream){
        state.selfieStream.getTracks().forEach(t=>t.stop());
        state.selfieStream=null;
        els.selfieVideo.srcObject=null;
        els.selfieVideo.style.display='none';
      }
      state.running=false;
      cancelAnimationFrame(state.rafId);
      setBadge('Hidden','warn');
    }
  });

  /*********** Event Listeners ***********/
  els.startBtn.addEventListener('click', startScan);
  els.captureBtn.addEventListener('click', captureSelfie);
  els.retakeBtn.addEventListener('click', retakeSelfie);
  els.submitSelfieBtn.addEventListener('click', submitSelfie);

  /*********** Init ***********/
  initDetector();

  // Debug exposure (optional)
  window.__qrState = state;
})();
</script>
</body>
</html>
