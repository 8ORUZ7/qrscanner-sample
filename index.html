<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Code Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<style>
  :root {
    color-scheme: light dark;
    --bg:#0f172a; --panel:#1e293b; --accent:#2563eb; --ok:#16a34a; --warn:#d97706; --err:#dc2626;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;min-height:100svh;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(circle at 30% 20%,#1e293b,#0f172a 70%);
    color:#f1f5f9;padding:1.25rem;
  }
  main{width:100%;max-width:560px;display:flex;flex-direction:column;gap:1rem;text-align:center;}
  h1{margin:0 0 .45rem;font-size:clamp(1.55rem,4.5vw,2.4rem);letter-spacing:.5px;}
  .step-indicator{font-size:.7rem;letter-spacing:.55px;text-transform:uppercase;opacity:.75;min-height:1rem;}
  .scanner-shell{
    position:relative;width:100%;max-width:520px;aspect-ratio:1/1;background:#000;
    border:2px solid #334155;border-radius:1rem;overflow:hidden;margin:0 auto;display:none;
    align-items:center;justify-content:center;
  }
  .scanner-shell.active{display:flex;}
  video{width:100%;height:100%;object-fit:cover;background:#000;}
  .mirrored{transform:scaleX(-1);}
  #scanVideo{display:none;}
  #selfieVideo{display:none;}
  canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;opacity:0;transition:opacity .18s ease;}
  #placeholderMsg{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:.9rem;opacity:.75;padding:1rem;text-align:center;
  }
  button{
    font:inherit;padding:.8rem 1.2rem;border-radius:.85rem;border:1px solid #475569;
    background:linear-gradient(#2563eb,#1d4ed8);color:#fff;font-weight:600;letter-spacing:.45px;
    cursor:pointer;transition:background .25s,transform .15s,opacity .25s;
  }
  button:hover:not(:disabled){background:linear-gradient(#3b82f6,#2563eb);}
  button:focus-visible{outline:3px solid #93c5fd;outline-offset:2px;}
  button:active:not(:disabled){transform:translateY(2px);}
  button:disabled{opacity:.55;cursor:not-allowed;}
  .panel{
    background:var(--panel);padding:1rem 1.15rem;border:1px solid #334155;border-radius:1rem;
    font-size:.9rem;text-align:left;display:none;
  }
  .panel.centered{text-align:center;}
  .greeting-msg{font-size:1.35rem;margin:.3rem 0 .55rem;font-weight:760;letter-spacing:.65px;}
  #selfieContainer{
    display:none;background:var(--panel);border:1px solid #334155;border-radius:1rem;
    padding:1rem 1rem 1.3rem;
  }
  #selfieHeader{font-size:.8rem;letter-spacing:.5px;opacity:.7;margin:0 0 .6rem;}
  #selfieLiveWrapper{
    position:relative;width:100%;max-width:520px;aspect-ratio:1/1;background:#000;border:2px solid #334155;
    border-radius:1rem;overflow:hidden;margin:0 auto .65rem;display:none;
  }
  #selfiePreview{
    max-width:100%;border-radius:.85rem;border:2px solid #334155;display:none;margin-top:.4rem;
  }
  .selfie-actions{display:flex;gap:.65rem;flex-wrap:wrap;justify-content:center;margin-top:.75rem;}
  .note{font-size:.63rem;opacity:.6;margin-top:.55rem;}
  .entry-wrapper{
    display:none;background:var(--panel);border:2px solid var(--ok);border-radius:1.1rem;
    padding:2.2rem 1.2rem 2.2rem;box-shadow:0 0 0 2px #16a34a55,0 8px 30px -10px #16a34acc;animation:fadeIn .4s ease;
  }
  .entry-msg{font-size:1.95rem;margin:0 0 .85rem;font-weight:850;letter-spacing:1px;color:var(--ok);}
  .countdown{font-size:.85rem;opacity:.9;margin:0;}
  @keyframes fadeIn{from{opacity:0;transform:scale(.96);}to{opacity:1;transform:scale(1);}}
  .pulse{animation:pulse 1.1s ease-in-out 2;}
  @keyframes pulse{0%{transform:scale(1);}40%{transform:scale(1.045);}100%{transform:scale(1);}}
  .hidden{display:none !important;}
  a.inline-reset{color:var(--accent);cursor:pointer;font-size:.7rem;text-decoration:none;margin-left:.45rem;}
  a.inline-reset:hover{text-decoration:underline;}
  .entry-clean #appTitle,
  .entry-clean #currentStep,
  .entry-clean #startBtn{display:none !important;}
  footer{margin-top:.7rem;font-size:.6rem;opacity:.55;}
  .entry-clean footer{display:none;}
  #fallbackSection{display:none;flex-direction:column;gap:.6rem;align-items:center;}
  #fallbackSection input[type=file]{font-size:.75rem;max-width:100%;color:#94a3b8;}
  #fallbackError{color:var(--err);font-size:.65rem;min-height:1rem;}
  #decodeStatus{font-size:.6rem;opacity:.65;min-height:1rem;}
  #html5qrContainer{
    position:absolute;inset:0;display:none;
  }
  #html5qrContainer > div{width:100%!important;height:100%!important;}
  #scanModeBadge{
    position:absolute;top:.45rem;left:.55rem;background:#1e293bcc;color:#fff;
    font-size:.55rem;padding:.25rem .45rem;border-radius:.5rem;letter-spacing:.5px;
    text-transform:uppercase;pointer-events:none;font-weight:600;
  }
</style>
</head>
<body>
<main id="appRoot">
  <h1 id="appTitle">Welcome!</h1>
  <div id="currentStep" class="step-indicator">Ready</div>

  <div class="scanner-shell" id="scannerShell" aria-label="QR scanner viewport">
    <div id="scanModeBadge" style="display:none;"></div>
    <video id="scanVideo" playsinline muted></video>
    <canvas id="scanCanvas" aria-hidden="true"></canvas>
    <div id="html5qrContainer">
      <div id="html5qr" style="width:100%;height:100%;"></div>
    </div>
    <div id="placeholderMsg">Tap Start Scan.</div>
  </div>

  <div>
    <button id="startBtn" type="button">Start Scan</button>
  </div>

  <div id="fallbackSection">
    <div style="font-size:.7rem;opacity:.75;">Camera unavailable. Use photo input:</div>
    <input id="fileInput" type="file" accept="image/*;capture=camera">
    <div style="display:flex;gap:.4rem;">
      <button id="decodeImageBtn" type="button" disabled>Decode Image</button>
      <button id="retryCameraBtn" type="button">Retry Camera</button>
    </div>
    <div id="fallbackError"></div>
    <div id="decodeStatus"></div>
  </div>

  <section class="panel centered" id="greetingPanel" aria-live="assertive">
    <div style="font-size:.65rem;opacity:.65;margin:0 0 .35rem;">Greeting</div>
    <p class="greeting-msg" id="greetingMsg"></p>
    <p id="greetingMeta" style="margin:0;font-size:.65rem;opacity:.65;"></p>
  </section>

  <section id="selfieContainer" aria-label="Selfie verification">
    <h2 id="selfieHeader">Selfie Verification</h2>
    <div id="selfieLiveWrapper">
      <video id="selfieVideo" playsinline muted></video>
    </div>
    <p id="selfieInstruction" style="margin:.2rem 0 .55rem;font-size:.8rem;opacity:.9;">Please take a selfie to continue.</p>
    <img id="selfiePreview" alt="Selfie preview" />
    <div class="selfie-actions">
      <button id="captureBtn" type="button" disabled>Capture Selfie</button>
      <button id="retakeBtn" type="button" disabled>Retake</button>
      <button id="submitSelfieBtn" type="button" disabled>Submit</button>
    </div>
    <p class="note">Selfie stays only in memory (not uploaded).</p>
  </section>

  <div id="entryPanel" class="entry-wrapper" aria-live="polite">
    <p class="entry-msg">PLEASE COME IN!</p>
    <p id="resetCountdown" class="countdown"></p>
  </div>
</main>

<!-- jsQR (removed integrity to avoid SRI mismatch) -->
<script id="lib-jsqr" src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" crossorigin="anonymous"></script>

<!-- html5-qrcode primary (jsDelivr) -->
<script id="lib-html5qr" src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js" crossorigin="anonymous"></script>
<script>
  // Fallback to unpkg if primary fails
  document.getElementById('lib-html5qr').addEventListener('error', () => {
    const alt = document.createElement('script');
    alt.src = 'https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js';
    alt.crossOrigin = 'anonymous';
    alt.onload = () => { window.__html5qrFallbackLoaded = true; };
    document.head.appendChild(alt);
  });
</script>

<script>
;(() => {
  "use strict";

  const USER_CODES = { "3OE0C1KD":"JOHN SMITH", "CKR9WLDM":"JANE DOE" };
  const THROTTLE_MS = 900;
  const ENTRY_RESET_SECONDS = 10;
  const HTML5QR_READY_TIMEOUT_MS = 1200; // wait max for html5-qrcode script

  const els = {
    appRoot: document.getElementById('appRoot'),
    step: document.getElementById('currentStep'),
    startBtn: document.getElementById('startBtn'),
    scannerShell: document.getElementById('scannerShell'),
    scanVideo: document.getElementById('scanVideo'),
    scanCanvas: document.getElementById('scanCanvas'),
    placeholder: document.getElementById('placeholderMsg'),
    greetingPanel: document.getElementById('greetingPanel'),
    greetingMsg: document.getElementById('greetingMsg'),
    greetingMeta: document.getElementById('greetingMeta'),
    selfieContainer: document.getElementById('selfieContainer'),
    selfieLiveWrapper: document.getElementById('selfieLiveWrapper'),
    selfieVideo: document.getElementById('selfieVideo'),
    selfieInstruction: document.getElementById('selfieInstruction'),
    selfiePreview: document.getElementById('selfiePreview'),
    captureBtn: document.getElementById('captureBtn'),
    retakeBtn: document.getElementById('retakeBtn'),
    submitSelfieBtn: document.getElementById('submitSelfieBtn'),
    entryPanel: document.getElementById('entryPanel'),
    resetCountdown: document.getElementById('resetCountdown'),
    fallbackSection: document.getElementById('fallbackSection'),
    fileInput: document.getElementById('fileInput'),
    decodeImageBtn: document.getElementById('decodeImageBtn'),
    retryCameraBtn: document.getElementById('retryCameraBtn'),
    fallbackError: document.getElementById('fallbackError'),
    decodeStatus: document.getElementById('decodeStatus'),
    html5qrContainer: document.getElementById('html5qrContainer'),
    modeBadge: document.getElementById('scanModeBadge')
  };

  const state = {
    scanStream:null,
    selfieStream:null,
    detector:null,
    decodeMode:'auto',
    running:false,
    scanning:false,
    lastValue:null,
    lastScanTs:0,
    rafId:null,
    resetIntervalId:null,
    resetSecondsRemaining:0,
    selfieStage:'idle',
    selfieData:null,
    useHtml5Qr:false,
    html5qrcode:null,
    html5Running:false,
    html5Available:false
  };

  const setStep = txt => els.step.textContent = txt;
  const isIOS = () =>
    /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

  function setModeBadge(text, level){
    els.modeBadge.style.display='block';
    els.modeBadge.textContent = text;
    els.modeBadge.style.background = level==='warn' ? '#d97706cc': level==='err' ? '#dc2626cc' : '#1e293bcc';
  }

  async function waitForHtml5Qrcode(){
    const start = performance.now();
    while (performance.now() - start < HTML5QR_READY_TIMEOUT_MS){
      if (window.Html5Qrcode) {
        state.html5Available = true;
        return true;
      }
      await new Promise(r=>setTimeout(r,80));
    }
    return false;
  }

  async function initDetector(){
    if (isIOS()){
      await waitForHtml5Qrcode();
      if (state.html5Available){
        state.useHtml5Qr = true;
        state.decodeMode = 'html5qrcode';
        setModeBadge('iOS: html5-qrcode', 'ok');
        return;
      } else {
        setModeBadge('iOS fallback jsQR', 'warn');
        state.useHtml5Qr = false;
      }
    }
    if ('BarcodeDetector' in window){
      try{
        const fmts = await BarcodeDetector.getSupportedFormats();
        if (fmts.includes('qr_code')){
          state.detector = new BarcodeDetector({ formats:['qr_code'] });
          state.decodeMode='barcode';
          setModeBadge('BarcodeDetector', 'ok');
          return;
        }
      }catch(e){}
    }
    state.decodeMode='jsQR';
    if(!state.useHtml5Qr) setModeBadge('jsQR', 'warn');
  }

  async function getScanStream(){
    const common = isIOS()
      ? { facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:720} }
      : { facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:1280} };
    return navigator.mediaDevices.getUserMedia({ video: common, audio:false });
  }

  async function waitForVideoReady(video, tries=40){
    return new Promise(resolve=>{
      const check=()=>{
        if (video.videoWidth > 0 && video.videoHeight > 0) return resolve();
        if (--tries <= 0) return resolve();
        setTimeout(check, 50);
      };
      if (video.readyState >= 2 && video.videoWidth>0) return resolve();
      video.addEventListener('loadedmetadata',()=>resolve(),{once:true});
      check();
    });
  }

  function stopStream(which){
    const key = which==='scan' ? 'scanStream' : 'selfieStream';
    if (state[key]){
      state[key].getTracks().forEach(t=>t.stop());
      state[key]=null;
    }
  }
  function stopHtml5Scanner() {
    if (state.html5qrcode && state.html5Running) {
      state.html5qrcode.stop().catch(()=>{}).finally(()=>{
        state.html5qrcode.clear();
        state.html5Running=false;
      });
    }
  }
  function stopAllScanning(){
    stopHtml5Scanner();
    stopStream('scan');
    cancelAnimationFrame(state.rafId);
    state.running=false;
  }

  async function startScan(){
    if (state.running || state.html5Running) return;
    softResetUI();
    setStep('Starting camera');

    els.scannerShell.classList.add('active');
    els.placeholder.style.display='none';
    els.startBtn.disabled = true;

    if (state.useHtml5Qr && state.html5Available){
      els.html5qrContainer.style.display='block';
      els.scanVideo.style.display='none';
      els.scanCanvas.style.display='none';
      try{
        if (!state.html5qrcode) state.html5qrcode = new Html5Qrcode("html5qr",{verbose:false});
        const config = {
          fps:10,
          qrbox:{width:250,height:250},
          aspectRatio:1,
          videoConstraints:{ facingMode:{ideal:'user'} }
        };
        await state.html5qrcode.start(
          config.videoConstraints,
          { fps:config.fps, qrbox:config.qrbox },
          decodedText => {
            const val = (decodedText||'').trim();
            const now = performance.now();
            if (!val) return;
            if (val === state.lastValue && (now - state.lastScanTs) < THROTTLE_MS) return;
            state.lastValue = val; state.lastScanTs = now;
            handleScanResult(val);
          },
          () => {}
        );
        state.html5Running = true;
        state.running = true;
        setStep('Scanning (Front Cam)');
      }catch(err){
        // Fallback to legacy path automatically
        state.useHtml5Qr = false;
        state.html5Available = false;
        els.html5qrContainer.style.display='none';
        setModeBadge('html5-qrcode fail → jsQR', 'warn');
        await legacyStart();
      }
      return;
    }

    await legacyStart();
  }

  async function legacyStart(){
    try{
      state.scanStream = await getScanStream();
    }catch(e){
      showFallback('Unable to access camera. Allow permission or use photo upload.');
      setStep('Camera unavailable');
      els.startBtn.disabled = false;
      return;
    }
    els.scanVideo.srcObject = state.scanStream;
    els.scanVideo.setAttribute('playsinline','true');
    els.scanVideo.setAttribute('autoplay','true');
    els.scanVideo.muted = true;
    await els.scanVideo.play();
    await waitForVideoReady(els.scanVideo);
    els.scanVideo.classList.add('mirrored');
    els.scanVideo.style.display='block';
    state.running = true;
    setStep('Scanning (Front Cam)');
    loop();
  }

  function loop(){
    if (!state.running || state.useHtml5Qr) return;
    state.rafId = requestAnimationFrame(loop);
    if (state.scanning) return;
    state.scanning = true;
    if (state.detector && state.decodeMode==='barcode'){
      state.detector.detect(els.scanVideo)
        .then(codes=>{
          if (codes && codes.length){
            handleScanResult(codes[0].rawValue);
          } else {
            tryJsQR().finally(()=> state.scanning=false);
          }
        }).catch(()=>{
          state.decodeMode='jsQR';
          tryJsQR().finally(()=> state.scanning=false);
        });
    } else {
      tryJsQR().finally(()=> state.scanning=false);
    }
  }

  function tryJsQR(){
    return new Promise(resolve=>{
      if (!window.jsQR) return resolve();
      const v=els.scanVideo;
      const vw=v.videoWidth, vh=v.videoHeight;
      if (!vw || !vh) return resolve();
      const ctx=els.scanCanvas.getContext('2d',{willReadFrequently:true});
      const side=Math.min(vw,vh);
      const sx=(vw-side)/2, sy=(vh-side)/2;
      els.scanCanvas.width=side; els.scanCanvas.height=side;
      try{
        ctx.drawImage(v,sx,sy,side,side,0,0,side,side);
        const img=ctx.getImageData(0,0,side,side);
        const qr=jsQR(img.data,img.width,img.height,{ inversionAttempts:'attemptBoth' });
        if(qr) handleScanResult(qr.data);
      }catch(e){}
      resolve();
    });
  }

  function handleScanResult(raw){
    const value=(''+raw).trim();
    if(!value) return;
    const now=performance.now();
    if(value===state.lastValue && (now - state.lastScanTs) < THROTTLE_MS) return;
    state.lastValue=value;
    state.lastScanTs=now;
    const name=USER_CODES[value.toUpperCase()];
    if(!name) return;

    stopAllScanning();
    els.scannerShell.classList.remove('active');
    els.scannerShell.style.display='none';
    showGreeting(name, value.toUpperCase());
    setTimeout(()=>startSelfie(name), 350);
  }

  function showFallback(msg){
    els.fallbackSection.style.display='flex';
    els.fallbackError.textContent = msg || '';
  }
  function hideFallback(){
    els.fallbackSection.style.display='none';
    els.fallbackError.textContent = '';
    els.decodeStatus.textContent = '';
    els.fileInput.value='';
    els.decodeImageBtn.disabled=true;
  }

  async function decodeSelectedImage(){
    els.decodeStatus.textContent='Decoding...';
    const file=els.fileInput.files?.[0];
    if(!file){ els.decodeStatus.textContent='No file.'; return; }
    const img=new Image();
    img.onload=()=>{
      try{
        const c=document.createElement('canvas');
        c.width=img.naturalWidth; c.height=img.naturalHeight;
        c.getContext('2d').drawImage(img,0,0);
        const id=c.getContext('2d').getImageData(0,0,c.width,c.height);
        const qr=jsQR(id.data,id.width,id.height,{ inversionAttempts:'attemptBoth' });
        if(qr){ els.decodeStatus.textContent='QR detected.'; handleScanResult(qr.data); }
        else els.decodeStatus.textContent='No QR found.';
      }catch(e){ els.decodeStatus.textContent='Decode error.'; }
    };
    img.onerror=()=> els.decodeStatus.textContent='Image load failed.';
    img.src=URL.createObjectURL(file);
  }

  function showGreeting(name, code){
    setStep('Greeting');
    els.greetingMsg.textContent=`Welcome Back ${name}!`;
    els.greetingMeta.textContent=`Code: ${code} • ${new Date().toLocaleTimeString()}`;
    els.greetingPanel.style.display='block';
    els.greetingPanel.classList.add('pulse');
    setTimeout(()=>els.greetingPanel.classList.remove('pulse'),1100);
  }

  async function startSelfie(name){
    setStep('Selfie');
    els.selfieContainer.style.display='block';
    els.selfieInstruction.textContent=`Please take a selfie to continue, ${name}.`;
    state.selfieStage='awaiting';
    els.selfieLiveWrapper.style.display='block';
    els.selfiePreview.style.display='none';
    els.captureBtn.disabled=true;
    try{
      state.selfieStream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:1280} },
        audio:false
      });
    }catch(e){
      els.selfieInstruction.textContent='Selfie camera blocked. Use photo input below.';
      addSelfieUploadFallback();
      return;
    }
    els.selfieVideo.srcObject=state.selfieStream;
    await els.selfieVideo.play();
    await waitForVideoReady(els.selfieVideo);
    els.selfieVideo.classList.add('mirrored');
    els.selfieVideo.style.display='block';
    els.captureBtn.disabled=false;
  }

  function addSelfieUploadFallback(){
    if (document.getElementById('selfieFileInput')) return;
    const up=document.createElement('input');
    up.type='file'; up.accept='image/*;capture=camera'; up.id='selfieFileInput';
    up.style.marginTop='.6rem';
    up.onchange=()=>{
      const file=up.files?.[0]; if(!file) return;
      const img=new Image();
      img.onload=()=>{
        const c=document.createElement('canvas');
        c.width=img.naturalWidth; c.height=img.naturalHeight;
        c.getContext('2d').drawImage(img,0,0);
        const dataUrl=c.toDataURL('image/jpeg',0.9);
        els.selfiePreview.src=dataUrl;
        els.selfiePreview.style.display='block';
        up.style.display='none';
        state.selfieData=dataUrl;
        state.selfieStage='captured';
        els.submitSelfieBtn.disabled=false;
        els.retakeBtn.disabled=false;
        els.captureBtn.disabled=true;
        els.selfieInstruction.textContent='Image ready. Submit or retake.';
      };
      img.src=URL.createObjectURL(file);
    };
    els.selfieContainer.appendChild(up);
    els.retakeBtn.onclick=()=>{
      state.selfieData=null;
      const input=document.getElementById('selfieFileInput');
      if (input){ input.value=''; input.style.display='block'; }
      els.selfiePreview.style.display='none';
      state.selfieStage='awaiting';
      els.submitSelfieBtn.disabled=true;
      els.retakeBtn.disabled=true;
      els.selfieInstruction.textContent='Select or capture a selfie.';
    };
  }

  function captureSelfie(){
    if (!['awaiting','captured'].includes(state.selfieStage)) return;
    if (!state.selfieStream) return alert('Camera not active.');
    const v=els.selfieVideo;
    const w=v.videoWidth, h=v.videoHeight;
    if (!w || !h) return;
    const off=document.createElement('canvas');
    off.width=w; off.height=h;
    off.getContext('2d').drawImage(v,0,0,w,h);
    state.selfieData=off.toDataURL('image/jpeg',0.9);
    els.selfiePreview.src=state.selfieData;
    els.selfiePreview.style.display='block';
    els.selfieVideo.style.display='none';
    els.selfieLiveWrapper.style.display='none';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=false;
    els.submitSelfieBtn.disabled=false;
    state.selfieStage='captured';
    els.selfieInstruction.textContent='Review your selfie. Submit or retake.';
  }

  function retakeSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieData=null;
    els.selfiePreview.style.display='none';
    els.selfieLiveWrapper.style.display='block';
    els.selfieVideo.style.display='block';
    els.captureBtn.disabled=false;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent='Please take a selfie to continue.';
  }

  function submitSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieStage='completed';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Selfie submitted.';
    proceedToEntry();
  }

  function proceedToEntry(){
    stopStream('selfie');
    els.selfieVideo.srcObject=null;
    els.selfieVideo.style.display='none';
    els.selfieLiveWrapper.style.display='none';
    els.greetingPanel.style.display='none';
    els.selfieContainer.style.display='none';
    showEntry();
  }

  function showEntry(){
    els.appRoot.classList.add('entry-clean');
    setStep('');
    els.entryPanel.style.display='block';
    beginAutoRefreshCountdown();
  }

  function beginAutoRefreshCountdown(){
    clearInterval(state.resetIntervalId);
    state.resetSecondsRemaining = ENTRY_RESET_SECONDS;
    updateCountdownText();
    state.resetIntervalId = setInterval(()=>{
      state.resetSecondsRemaining--;
      if (state.resetSecondsRemaining <= 0){
        clearInterval(state.resetIntervalId);
        location.reload();
      } else {
        updateCountdownText();
      }
    },1000);
  }

  function updateCountdownText(){
    els.resetCountdown.innerHTML =
      `Refreshing in ${state.resetSecondsRemaining}s... <a class="inline-reset" id="resetNowLink">(Refresh Now)</a>`;
    const link=document.getElementById('resetNowLink');
    if (link) link.onclick = e => { e.preventDefault(); location.reload(); };
  }

  function softResetUI(){
    cancelAnimationFrame(state.rafId);
    stopAllScanning();
    stopStream('selfie');
    state.scanning=false; state.lastValue=null;
    els.appRoot.classList.remove('entry-clean');
    els.scannerShell.classList.remove('active');
    els.scanVideo.style.display='none';
    els.html5qrContainer.style.display='none';
    els.placeholder.style.display='flex';
    els.greetingPanel.style.display='none';
    els.selfieContainer.style.display='none';
    els.entryPanel.style.display='none';
    els.selfiePreview.style.display='none';
    els.selfieLiveWrapper.style.display='none';
    els.startBtn.disabled=false;
    els.captureBtn.disabled=true; els.retakeBtn.disabled=true; els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Please take a selfie to continue.';
    els.step.textContent='Ready';
    hideFallback();
    if (state.resetIntervalId){
      clearInterval(state.resetIntervalId);
      state.resetIntervalId=null;
    }
  }

  document.addEventListener('visibilitychange',()=>{
    if (document.hidden){
      stopAllScanning();
      stopStream('selfie');
      state.running=false;
    }
  });

  // Fallback
  els.fileInput.addEventListener('change', ()=>{
    els.decodeImageBtn.disabled = !els.fileInput.files?.length;
    els.decodeStatus.textContent='';
  });
  els.decodeImageBtn.addEventListener('click', decodeSelectedImage);
  els.retryCameraBtn.addEventListener('click', ()=> {
    hideFallback();
    startScan();
  });

  els.startBtn.addEventListener('click', startScan);
  els.captureBtn.addEventListener('click', captureSelfie);
  els.retakeBtn.addEventListener('click', retakeSelfie);
  els.submitSelfieBtn.addEventListener('click', submitSelfie);

  initDetector();
  window.__qrState = state;
})();
</script>
</body>
</html>
