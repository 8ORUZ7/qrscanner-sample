<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Simple QR Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color-scheme: light dark; }
  body {
    margin:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    background:#0f172a; color:#f1f5f9; padding:1.25rem; gap:1rem;
  }
  h1 { margin:.25rem 0 .5rem; font-size:1.6rem; text-align:center; }
  #videoWrapper {
    position:relative; width:min(90vw,420px); aspect-ratio:1/1;
    background:#000; border:2px solid #334155; border-radius:1rem; overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }
  video { width:100%; height:100%; object-fit:cover; display:none; transform:scaleX(-1); }
  canvas { position:absolute; inset:0; width:100%; height:100%; pointer-events:none; opacity:0; transition:opacity .18s; }
  #placeholder { text-align:center; font-size:.9rem; opacity:.75; padding:0 .75rem; }
  #actionBtn {
    font:inherit; font-weight:600; letter-spacing:.5px;
    background:#2563eb; color:#fff; border:1px solid #1d4ed8; border-radius:.8rem;
    padding:.9rem 1.4rem; cursor:pointer; min-width:200px;
  }
  #actionBtn:disabled { opacity:.55; cursor:not-allowed; }
  #actionBtn:not(:disabled):active { transform:translateY(2px); }
  #status { min-height:1.2rem; font-size:.75rem; opacity:.75; }
  .panel {
    width:100%; max-width:420px; background:#1e293b; border:1px solid #334155;
    border-radius:.9rem; padding:.9rem 1rem; font-size:.9rem; display:none;
  }
  .center { text-align:center; }
  #greeting { font-size:1.05rem; font-weight:600; margin:0 0 .4rem; }
  #entryMsg { font-size:1.3rem; font-weight:700; margin:.25rem 0 0; color:#16a34a; }
  #preview { width:100%; border-radius:.6rem; margin-top:.5rem; display:none; }
  small { font-size:.65rem; opacity:.6; }
  .flash { opacity:.85 !important; }
</style>
</head>
<body>
  <h1>QR Scanner</h1>

  <div id="videoWrapper">
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div id="placeholder">Step 1: Tap the button to start.<br>Allow camera (front).</div>
  </div>

  <button id="actionBtn" type="button">Start Scan</button>
  <div id="status" aria-live="polite">Idle</div>

  <div id="resultPanel" class="panel center">
    <p id="greeting"></p>
    <div id="rawLine" style="word-break:break-word;"></div>
    <img id="preview" alt="Selfie preview">
    <div id="entryMsg"></div>
    <small id="hint"></small>
  </div>

<script defer src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"
        integrity="sha384-rC5NcI3F9zeJq82cC28hvMmjr4neTJD7sPXQf8zl9uG6MS5Icnvx8e3UgFF3Rdg6"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
(() => {
  "use strict";

  /* ----------- CONFIG ----------- */
  const USER_CODES = {
    "3OE0C1KD": "JOHN SMITH",
    "CKR9WLDM": "JANE DOE"
  };
  const SELFIE_CODE = "CKR9WLDM";
  const AUTO_RESET_MS = 6000; // after entry granted / JOHN greeting

  /* ----------- ELEMENTS ---------- */
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });
  const btn = document.getElementById('actionBtn');
  const statusEl = document.getElementById('status');
  const placeholder = document.getElementById('placeholder');
  const resultPanel = document.getElementById('resultPanel');
  const greetingEl = document.getElementById('greeting');
  const rawLine = document.getElementById('rawLine');
  const preview = document.getElementById('preview');
  const entryMsg = document.getElementById('entryMsg');
  const hint = document.getElementById('hint');

  /* ----------- STATE ------------- */
  const state = {
    phase: 'idle', // idle | scanning | greet_john | greet_jane | selfie_ready | selfie_captured | entry
    stream: null,
    lastCode: null,
    lastTime: 0,
    throttleMs: 1200,
    raf: 0,
    detector: null,
    useBarcode: false,
    resetTimer: null
  };

  /* ----------- HELPERS ----------- */
  function setStatus(msg) { statusEl.textContent = msg; }

  async function initBarcodeDetector() {
    if ('BarcodeDetector' in window) {
      try {
        const fmts = await BarcodeDetector.getSupportedFormats();
        if (fmts.includes('qr_code')) {
          state.detector = new BarcodeDetector({ formats: ['qr_code'] });
          state.useBarcode = true;
          setStatus('Ready (BarcodeDetector)');
        } else throw 0;
      } catch {
        state.useBarcode = false;
        setStatus('Ready (jsQR)');
      }
    } else {
      setStatus('Ready (jsQR)');
    }
  }

  function changePhase(phase) {
    state.phase = phase;
    // Update button label according to phase
    switch (phase) {
      case 'idle':
        btn.textContent = 'Start Scan';
        break;
      case 'scanning':
        btn.textContent = 'Scanning...'; // disable? keep active? We'll disable to prevent extra clicks
        break;
      case 'greet_john':
        btn.textContent = 'Start Again (after reset)';
        break;
      case 'greet_jane':
        btn.textContent = 'Take Selfie';
        break;
      case 'selfie_ready':
        btn.textContent = 'Capture Selfie';
        break;
      case 'selfie_captured':
        btn.textContent = 'Submit Selfie';
        break;
      case 'entry':
        btn.textContent = 'Start Again (after reset)';
        break;
    }
  }

  function resetAll() {
    cancelAnimationFrame(state.raf);
    if (state.stream) state.stream.getTracks().forEach(t => t.stop());
    state.stream = null;
    video.srcObject = null;
    video.style.display = 'none';
    placeholder.style.display = 'flex';
    resultPanel.style.display = 'none';
    greetingEl.textContent = '';
    rawLine.textContent = '';
    preview.style.display = 'none';
    entryMsg.textContent = '';
    hint.textContent = '';
    canvas.width = canvas.height = 0;
    state.lastCode = null;
    if (state.resetTimer) clearTimeout(state.resetTimer);
    changePhase('idle');
    btn.disabled = false;
    setStatus('Idle');
  }

  function scheduleAutoReset() {
    if (state.resetTimer) clearTimeout(state.resetTimer);
    state.resetTimer = setTimeout(resetAll, AUTO_RESET_MS);
    hint.textContent = 'Resetting in ' + (AUTO_RESET_MS/1000) + 's...';
  }

  /* ----------- CAMERA + SCAN ----- */
  async function startCamera() {
    try {
      state.stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'user' },
          width: { ideal: 1280 }, height: { ideal: 1280 }, aspectRatio: 1
        },
        audio: false
      });
    } catch (e) {
      // fallback by enumerating
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d=>d.kind==='videoinput');
        const front = vids.find(d=>/front|user|face/i.test(d.label)) || vids[0];
        if (!front) throw new Error('No camera');
        state.stream = await navigator.mediaDevices.getUserMedia({
          video:{ deviceId:{ exact: front.deviceId }}, audio:false
        });
      } catch (e2) {
        setStatus('Camera denied');
        btn.disabled = false;
        return false;
      }
    }
    video.srcObject = state.stream;
    await video.play();
    video.style.display = 'block';
    placeholder.style.display = 'none';
    return true;
  }

  function scanLoop() {
    if (state.phase !== 'scanning') return;
    state.raf = requestAnimationFrame(scanLoop);

    if (state.useBarcode && state.detector) {
      state.detector.detect(video)
        .then(codes => {
          if (codes && codes.length) processCode(codes[0].rawValue, 'BarcodeDetector');
          else fallbackJsQR();
        })
        .catch(() => {
          state.useBarcode = false;
          fallbackJsQR();
        });
    } else {
      fallbackJsQR();
    }
  }

  function fallbackJsQR() {
    if (!window.jsQR) return;
    const vw = video.videoWidth, vh = video.videoHeight;
    if (!vw || !vh) return;
    // crop center square for consistency
    const side = Math.min(vw, vh);
    const sx = (vw - side)/2;
    const sy = (vh - side)/2;
    canvas.width = side;
    canvas.height = side;
    ctx.drawImage(video, sx, sy, side, side, 0, 0, side, side);
    const img = ctx.getImageData(0,0,side,side);
    const qr = window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
    if (qr) drawPolyline(qr.location), processCode(qr.data, 'jsQR');
  }

  function drawPolyline(loc) {
    if (!loc) return;
    ctx.strokeStyle = '#16a34a';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
    ctx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
    ctx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
    ctx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
    ctx.closePath();
    ctx.stroke();
    canvas.classList.add('flash');
    setTimeout(()=>canvas.classList.remove('flash'),180);
  }

  function processCode(val, source) {
    const code = (val||'').trim();
    const t = performance.now();
    if (!code) return;
    if (code === state.lastCode && (t - state.lastTime) < state.throttleMs) return;
    state.lastCode = code;
    state.lastTime = t;

    const upper = code.toUpperCase();
    const name = USER_CODES[upper];
    resultPanel.style.display = 'block';
    rawLine.textContent = 'Raw: ' + code + ' ('+source+')';

    if (!name) {
      greetingEl.textContent = 'Unrecognized code';
      return;
    }

    greetingEl.textContent = 'WELCOME BACK, ' + name + '!';
    if (upper === SELFIE_CODE) {
      changePhase('greet_jane');
      // Pause scanning to avoid repeated triggers
      changePhase('greet_jane');
      // Stop loop but keep camera stream for selfie
      state.phase = 'greet_jane';
      setStatus('Greeting JANE DOE');
      btn.disabled = false;
      btn.textContent = 'Take Selfie';
    } else {
      changePhase('greet_john');
      setStatus('Greeting JOHN SMITH');
      scheduleAutoReset();
    }
  }

  /* ----------- SELFIE FLOW -------- */
  function handleSelfieButton() {
    if (state.phase === 'greet_jane') {
      // move to selfie ready (video already playing)
      changePhase('selfie_ready');
      setStatus('Selfie: capture');
      btn.textContent = 'Capture Selfie';
      hint.textContent = 'Center your face then tap.';
      return;
    }
    if (state.phase === 'selfie_ready') {
      captureSelfie();
      return;
    }
    if (state.phase === 'selfie_captured') {
      submitSelfie();
      return;
    }
  }

  function captureSelfie() {
    const vw = video.videoWidth, vh = video.videoHeight;
    const side = Math.min(vw,vh);
    const sx = (vw - side)/2, sy = (vh - side)/2;
    const off = document.createElement('canvas');
    off.width = side; off.height = side;
    off.getContext('2d').drawImage(video, sx, sy, side, side, 0,0,side,side);
    const dataUrl = off.toDataURL('image/jpeg', 0.92);
    preview.src = dataUrl;
    preview.style.display = 'block';
    hint.textContent = 'Tap again to submit.';
    changePhase('selfie_captured');
    setStatus('Selfie captured');
  }

  function submitSelfie() {
    changePhase('entry');
    preview.style.display = 'block';
    entryMsg.textContent = 'PLEASE, COME IN!';
    hint.textContent = '';
    setStatus('Entry granted');
    scheduleAutoReset();
  }

  /* ----------- BUTTON HANDLER ----- */
  btn.addEventListener('click', async () => {
    switch (state.phase) {
      case 'idle':
        btn.disabled = true;
        setStatus('Starting camera...');
        await initDetector();
        if (!(await startCamera())) return;
        changePhase('scanning');
        btn.disabled = true; // disable during scanning
        setStatus('Scanning...');
        scanLoop();
        break;
      case 'greet_john':
      case 'entry':
        // Ignore until auto reset OR allow manual immediate reset:
        resetAll();
        break;
      case 'greet_jane':
      case 'selfie_ready':
      case 'selfie_captured':
        handleSelfieButton();
        break;
      default:
        // If user clicks while scanning - no action (one button rule)
        break;
    }
  });

  /* ----------- VISIBILITY ---------- */
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      // if user leaves page we stop everything
      resetAll();
    }
  });

  // Prepare initial status
  setStatus('Idle');

})();
</script>
</body>
</html>
