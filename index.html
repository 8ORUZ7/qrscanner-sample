<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Code Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    color-scheme: light dark;
    --bg: #0f172a;
    --panel: #1e293b;
    --accent: #2563eb;
    --ok: #16a34a;
    --err: #dc2626;
    --warn: #d97706;
    --focus: #93c5fd;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    min-height: 100svh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(circle at 30% 20%, #1e293b, #0f172a 70%);
    color: #f1f5f9;
    padding: 1.25rem;
  }
  main {
    width: 100%;
    max-width: 540px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  h1 { margin: 0 0 .25rem; font-size: clamp(1.55rem,4.5vw,2.35rem); letter-spacing: .5px; }
  .scanner-shell {
    position: relative;
    width: 100%;
    max-width: 500px;
    aspect-ratio: 1 / 1;
    background: #000;
    border: 2px solid #334155;
    border-radius: 1rem;
    overflow: hidden;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: none;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
    transform: scaleX(-1);
  }
  canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    opacity: 0;
  }
  .overlay { position: absolute; inset: 0; pointer-events: none; }
  .overlay::before {
    content: "";
    position: absolute; inset: 0;
    background: radial-gradient(circle at center, rgba(0,0,0,.0) 60%, rgba(0,0,0,.55) 82%);
  }
  .frame-corner {
    position: absolute;
    width: 2.3rem; height: 2.3rem;
    border: 4px solid var(--accent);
    filter: drop-shadow(0 0 4px var(--accent));
  }
  .frame-corner.tl { top:10%; left:10%; border-right:0; border-bottom:0; }
  .frame-corner.tr { top:10%; right:10%; border-left:0; border-bottom:0; }
  .frame-corner.bl { bottom:10%; left:10%; border-right:0; border-top:0; }
  .frame-corner.br { bottom:10%; right:10%; border-left:0; border-top:0; }
  button {
    font: inherit; padding:.75rem 1.1rem; border-radius:.8rem;
    border:1px solid #475569; background:linear-gradient(#2563eb,#1d4ed8);
    color:#fff; cursor:pointer; font-weight:600; letter-spacing:.4px;
    transition:background .25s, transform .15s;
  }
  button:hover:not(:disabled){background:linear-gradient(#3b82f6,#2563eb);}
  button:focus-visible{outline:3px solid var(--focus); outline-offset:2px;}
  button:active:not(:disabled){transform:translateY(2px);}
  button:disabled{opacity:.55; cursor:not-allowed;}
  .status { min-height:1.5rem; font-size:.8rem; display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; }
  .badge{padding:.25rem .6rem; border-radius:1rem; background:#334155; font-weight:500;}
  .badge.ok{background:var(--ok); color:#fff;}
  .badge.err{background:var(--err); color:#fff;}
  .badge.warn{background:var(--warn); color:#fff;}
  .panel {
    background:var(--panel); padding:.95rem 1.05rem; border:1px solid #334155;
    border-radius:.95rem; font-size:.9rem; text-align:left; word-break:break-word; display:none;
  }
  .panel.centered { text-align:center; }
  .panel.success { border-color:var(--ok); box-shadow:0 0 0 2px #16a34a55,0 4px 18px -6px #16a34aaa;}
  .greeting-msg{font-size:1.1rem; margin:0 0 .4rem; font-weight:600; letter-spacing:.5px;}
  .entry-msg{font-size:1.35rem; margin:0; font-weight:700; letter-spacing:1px; color:var(--ok);}
  code.inline{background:#0f172a; padding:.15rem .4rem .25rem; border-radius:.4rem; font-size:.75rem; font-family:ui-monospace,monospace;}
  a.result-link{color:var(--accent); text-decoration:none;}
  a.result-link:hover{text-decoration:underline;}
  #selfiePreview{max-width:100%; border-radius:.75rem; border:2px solid #334155; display:none; margin-top:.65rem;}
  .selfie-actions{display:flex; gap:.6rem; flex-wrap:wrap; justify-content:center; margin-top:.75rem;}
  .note{font-size:.7rem; opacity:.65; margin-top:.5rem;}
  footer{margin-top:.75rem; font-size:.65rem; opacity:.55;}
  .pulse{animation:pulse 1.25s ease-in-out 2;}
  @keyframes pulse{0%{transform:scale(1);}40%{transform:scale(1.045);}100%{transform:scale(1);}}
  .reset-countdown{font-size:.7rem; opacity:.65; margin-top:.4rem;}
  .method-indicator{font-size:.65rem; opacity:.7; margin-top:.25rem;}
</style>
</head>
<body>
<main>
  <header><h1>QR Scanner</h1></header>

  <div class="scanner-shell" id="scannerShell" aria-label="QR scanner viewport">
    <video id="video" playsinline muted></video>
    <canvas id="canvas" aria-hidden="true"></canvas>
    <div class="overlay" aria-hidden="true">
      <div class="frame-corner tl"></div>
      <div class="frame-corner tr"></div>
      <div class="frame-corner bl"></div>
      <div class="frame-corner br"></div>
    </div>
    <div id="placeholderMsg"
      style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.9rem;opacity:.75;padding:1rem;text-align:center;">
      Camera inactive.<br/>Tap Start Scan.
    </div>
  </div>

  <div style="display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap;">
    <button id="startBtn" type="button">Start Scan</button>
    <button id="stopBtn" type="button" disabled>Stop</button>
    <button id="pauseBtn" type="button" disabled>Pause</button>
    <button id="restartBtn" type="button" style="display:none;">Restart</button>
  </div>

  <div class="status" id="status" role="status" aria-live="polite">
    <span class="badge" id="envBadge">Idle</span>
    <span class="badge" id="cvBadge" style="display:none;">CV Loading</span>
  </div>
  <div class="method-indicator" id="methodIndicator"></div>

  <section class="panel centered" id="greetingBox" aria-live="assertive">
    <p class="greeting-msg" id="greetingMsg"></p>
    <p style="margin:0;font-size:.7rem;opacity:.7;" id="greetingMeta"></p>
  </section>

  <section class="panel centered" id="selfieSection" aria-label="Selfie capture section">

    <p id="selfieInstruction" style="margin:.1rem 0 .55rem;font-size:.8rem;opacity:.85;">
      Hi JANE DOE, please take a selfie to continue.
    </p>
    <img id="selfiePreview" alt="Selfie preview" />
    <div class="selfie-actions">
      <button id="captureBtn" type="button">Capture Selfie</button>
      <button id="retakeBtn" type="button" disabled>Retake</button>
      <button id="submitSelfieBtn" type="button" disabled>Submit</button>
    </div>
    <p class="note">Selfie stays only in this session (not uploaded).</p>
  </section>

  <section class="panel centered success" id="entryBox" aria-live="assertive">
    <p class="entry-msg" id="entryMsg" style="display:none;">PLEASE, COME IN!</p>
    <p id="entryMeta" style="margin:.35rem 0 0;font-size:.7rem;opacity:.7;"></p>
    <p class="reset-countdown" id="resetCountdown" style="display:none;"></p>
  </section>

  <section class="panel" id="resultBox" aria-label="Latest scan result">
    <h2>Raw Scan Result</h2>
    <div><strong>Value:</strong> <span id="resultText"></span></div>
    <div id="urlLine" style="margin-top:.4rem; display:none;">Interpreted as URL:
      <a id="resultLink" class="result-link" href="#" target="_blank" rel="noopener noreferrer"></a>
    </div>
    <div style="margin-top:.6rem; font-size:.7rem; opacity:.7;">
      Source: <code class="inline" id="sourceLabel"></code> • Time: <code class="inline" id="timeLabel"></code>
    </div>
  </section>

  <footer>
    Order: BarcodeDetector → jsQR → OpenCV.js for tougher codes. (OpenCV loads lazily; first load is slower)
  </footer>
</main>

<!-- jsQR fallback -->
<script defer src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"
        integrity="sha384-rC5NcI3F9zeJq82cC28hvMmjr4neTJD7sPXQf8zl9uG6MS5Icnvx8e3UgFF3Rdg6"
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- OpenCV.js (asynchronous) -->
<script>
  // Show CV badge while loading
  document.addEventListener('DOMContentLoaded', () => {
    const badge = document.getElementById('cvBadge');
    badge.style.display = 'inline-block';
  });
  // Configure OpenCV module
  window.Module = {
    onRuntimeInitialized() {
      window.__openCvReady = true;
      const badge = document.getElementById('cvBadge');
      badge.textContent = 'CV Ready';
      badge.classList.add('ok');
      // (Optional) remove after a few seconds
      setTimeout(()=>badge.style.display='none', 4000);
    }
  };
</script>
<script async src="https://docs.opencv.org/4.x/opencv.js" crossorigin="anonymous"></script>

<script>
;(() => {
  "use strict";

  /***************** CONFIG *****************/
  const USER_CODES = Object.freeze({
    "3OE0C1KD":"JOHN SMITH",
    "CKR9WLDM":"JANE DOE"
  });
  const SELFIE_REQUIRED_CODE = "CKR9WLDM";
  const AUTO_RESET_DELAY_MS = 7000;
  // After how many ms of no successful decode we temporarily prefer OpenCV first
  const CV_BOOST_THRESHOLD_MS = 3500;
  /******************************************/

  const els = {
    shell: document.getElementById('scannerShell'),
    video: document.getElementById('video'),
    canvas: document.getElementById('canvas'),
    startBtn: document.getElementById('startBtn'),
    stopBtn: document.getElementById('stopBtn'),
    pauseBtn: document.getElementById('pauseBtn'),
    restartBtn: document.getElementById('restartBtn'),
    envBadge: document.getElementById('envBadge'),
    resultBox: document.getElementById('resultBox'),
    resultText: document.getElementById('resultText'),
    resultLink: document.getElementById('resultLink'),
    urlLine: document.getElementById('urlLine'),
    sourceLabel: document.getElementById('sourceLabel'),
    timeLabel: document.getElementById('timeLabel'),
    placeholder: document.getElementById('placeholderMsg'),
    greetingBox: document.getElementById('greetingBox'),
    greetingMsg: document.getElementById('greetingMsg'),
    greetingMeta: document.getElementById('greetingMeta'),
    selfieSection: document.getElementById('selfieSection'),
    captureBtn: document.getElementById('captureBtn'),
    retakeBtn: document.getElementById('retakeBtn'),
    submitSelfieBtn: document.getElementById('submitSelfieBtn'),
    selfiePreview: document.getElementById('selfiePreview'),
    selfieInstruction: document.getElementById('selfieInstruction'),
    entryBox: document.getElementById('entryBox'),
    entryMsg: document.getElementById('entryMsg'),
    entryMeta: document.getElementById('entryMeta'),
    resetCountdown: document.getElementById('resetCountdown'),
    methodIndicator: document.getElementById('methodIndicator')
  };

  const state = {
    running:false,
    paused:false,
    stream:null,
    track:null,
    detector:null, // BarcodeDetector
    decodeMode:'auto',
    scanning:false,
    lastValue:null,
    lastScanTs:0,
    throttleMs:900,
    rafId:null,
    greetedCodes:new Set(),
    selfieStage:'idle', // idle | awaiting | captured | completed
    selfieDataUrl:null,
    resetTimerId:null,
    resetCountdownId:null,
    resetRemainingSec:0,
    lastDecodeSuccessTime:0,
    cvDetector:null,
    openCvTries:0
  };

  function setBadge(text, level) {
    els.envBadge.textContent = text;
    els.envBadge.className = 'badge' + (level? ' '+level:'');
  }

  async function initDetector() {
    if ('BarcodeDetector' in window) {
      try {
        const formats = await BarcodeDetector.getSupportedFormats();
        if (formats.includes('qr_code')) {
          state.detector = new BarcodeDetector({ formats:['qr_code']});
          state.decodeMode='barcode';
          setBadge('Ready (BarcodeDetector)','ok');
          return;
        }
      } catch(e) { console.warn('BarcodeDetector init failed', e); }
    }
    state.decodeMode='jsqr';
    setBadge('Ready (jsQR fallback)','warn');
  }

  async function start() {
    if (state.running) return;
    try {
      state.stream = await navigator.mediaDevices.getUserMedia({
        video:{
          facingMode:{ideal:'user'},
          width:{ideal:1280},
          height:{ideal:1280},
          aspectRatio:1
        },
        audio:false
      });
    } catch(e) {
      console.warn('Primary getUserMedia failed', e);
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d=>d.kind==='videoinput');
        const front = vids.find(d=>/front|user|face/i.test(d.label)) || vids[0];
        if(!front) throw new Error('No camera');
        state.stream = await navigator.mediaDevices.getUserMedia({
          video:{deviceId:{exact:front.deviceId}},
          audio:false
        });
      } catch(e2) {
        console.error('Camera access failed', e2);
        setBadge('Camera denied','err');
        return;
      }
    }
    state.track = state.stream.getVideoTracks()[0];
    els.video.srcObject = state.stream;
    await els.video.play();
    els.video.style.display='block';
    els.placeholder.style.display='none';
    state.running = true;
    state.paused = false;
    els.startBtn.disabled = true;
    els.stopBtn.disabled = false;
    els.pauseBtn.disabled = false;
    els.restartBtn.style.display='none';
    setBadge('Scanning ('+state.decodeMode+')','ok');
    state.lastDecodeSuccessTime = performance.now();
    loop();
  }

  function stop() {
    state.running=false;
    state.paused=false;
    cancelAnimationFrame(state.rafId);
    if (state.stream) state.stream.getTracks().forEach(t=>t.stop());
    state.stream=null;
    els.video.srcObject=null;
    els.video.style.display='none';
    els.placeholder.style.display='flex';
    els.startBtn.disabled=false;
    els.stopBtn.disabled=true;
    els.pauseBtn.disabled=true;
    els.pauseBtn.textContent='Pause';
    setBadge('Stopped','warn');
  }

  function pauseResume() {
    if (!state.running) return;
    state.paused=!state.paused;
    els.pauseBtn.textContent = state.paused? 'Resume':'Pause';
    if (!state.paused) {
      setBadge('Scanning ('+state.decodeMode+')','ok');
      loop();
    } else {
      cancelAnimationFrame(state.rafId);
      setBadge('Paused','warn');
    }
  }

  function loop() {
    if (!state.running || state.paused) return;
    state.rafId = requestAnimationFrame(loop);
    if (state.scanning) return;
    state.scanning = true;

    const now = performance.now();
    const timeSinceSuccess = now - state.lastDecodeSuccessTime;
    // If long time without success and OpenCV ready, try it earlier
    const preferCV = window.__openCvReady && timeSinceSuccess > CV_BOOST_THRESHOLD_MS;

    if (preferCV) {
      tryOpenCV()
        .then(found => {
          if (!found) return tryBarcodeThenJsQR();
        })
        .finally(()=> state.scanning=false);
    } else {
      tryBarcodeThenJsQR().finally(()=>{
        if (!state.lastFrameDecoded && window.__openCvReady) {
          // secondary OpenCV attempt this frame
          tryOpenCV().finally(()=>state.scanning=false);
        } else {
          state.scanning=false;
        }
      });
    }
  }

  function tryBarcodeThenJsQR() {
    state.lastFrameDecoded = false;
    if (state.detector && state.decodeMode==='barcode') {
      return state.detector.detect(els.video)
        .then(codes=>{
          if (codes && codes.length) {
            handleResult(codes[0].rawValue,{source:'BarcodeDetector', format:codes[0].format});
            state.lastFrameDecoded = true;
          } else {
            return tryJsQR().then(found => { if(found) state.lastFrameDecoded=true; });
          }
        })
        .catch(err=>{
          console.warn('BarcodeDetector error switching to jsQR', err);
          state.decodeMode='jsqr';
          setBadge('Fallback jsQR','warn');
          return tryJsQR().then(found=>{ if(found) state.lastFrameDecoded=true; });
        });
    } else {
      return tryJsQR().then(found=>{ if(found) state.lastFrameDecoded=true; });
    }
  }

  function getSquareFrame(ctx) {
    const v = els.video;
    const vw = v.videoWidth;
    const vh = v.videoHeight;
    if (!vw || !vh) return null;
    const side = Math.min(vw,vh);
    const sx = (vw - side)/2;
    const sy = (vh - side)/2;
    els.canvas.width = side;
    els.canvas.height = side;
    ctx.drawImage(v, sx, sy, side, side, 0, 0, side, side);
    return { side };
  }

  function tryJsQR() {
    return new Promise(resolve=>{
      if (!window.jsQR) return resolve(false);
      const ctx = els.canvas.getContext('2d',{willReadFrequently:true});
      const frame = getSquareFrame(ctx);
      if (!frame) return resolve(false);
      const img = ctx.getImageData(0,0,frame.side,frame.side);
      const qr = window.jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
      if (qr) {
        handleResult(qr.data,{source:'jsQR', location:qr.location});
        resolve(true);
      } else {
        resolve(false);
      }
    });
  }

  async function tryOpenCV() {
    if (!window.__openCvReady || !window.cv) return false;
    try {
      if (!state.cvDetector) state.cvDetector = new cv.QRCodeDetector();
      const v = els.video;
      const vw = v.videoWidth;
      const vh = v.videoHeight;
      if (!vw || !vh) return false;

      // Use central square like UI
      const side = Math.min(vw,vh);
      const sx = (vw - side)/2;
      const sy = (vh - side)/2;
      // Draw to offscreen canvas
      const off = document.createElement('canvas');
      off.width = side; off.height = side;
      const octx = off.getContext('2d');
      octx.drawImage(v, sx, sy, side, side, 0,0,side,side);
      const imgData = octx.getImageData(0,0,side,side);

      let src = cv.matFromImageData(imgData);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

      // Light adaptive threshold to improve contrast (copy, not destructive)
      let thresh = new cv.Mat();
      cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY, 41, 7);

      let points = new cv.Mat();
      let straight = new cv.Mat();
      let decoded = state.cvDetector.detectAndDecode(thresh, points, straight);

      // If first pass failed, try original gray
      if (!decoded) {
        decoded = state.cvDetector.detectAndDecode(gray, points, straight);
      }

      if (decoded) {
        const loc = interpretPoints(points);
        handleResult(decoded,{source:'OpenCV', location:loc});
        cleanup([src,gray,thresh,points,straight]);
        return true;
      }
      cleanup([src,gray,thresh,points,straight]);
      return false;
    } catch(e) {
      console.warn('OpenCV decode error', e);
      return false;
    }
  }

  function interpretPoints(pointsMat) {
    // pointsMat: 1x4x2 (if detected)
    if (!pointsMat || pointsMat.data32F === undefined || pointsMat.size().height === 0) return null;
    const data = pointsMat.data32F;
    if (!data || data.length < 8) return null;
    const pt = i => ({ x: data[i*2], y: data[i*2+1] });
    return {
      topLeftCorner: pt(0),
      topRightCorner: pt(1),
      bottomRightCorner: pt(2),
      bottomLeftCorner: pt(3)
    };
  }

  function cleanup(arr){ arr.forEach(m=>{ try{ m.delete(); }catch(e){} }); }

  function isLikelyURL(str){ return /^https?:\/\/[^\s]+$/i.test(str.trim()); }

  function handleResult(raw, meta) {
    if (!raw) return;
    const value = (''+raw).trim();
    const now = performance.now();
    if (value === state.lastValue && (now - state.lastScanTs) < state.throttleMs) return;
    state.lastValue = value;
    state.lastScanTs = now;
    state.lastDecodeSuccessTime = now;

    els.methodIndicator.textContent = 'Decoded via: ' + meta.source;

    renderRaw(value, meta);
    const recognized = greet(value);
    highlight(meta);
    if (recognized && value.toUpperCase() === SELFIE_REQUIRED_CODE && state.selfieStage==='idle') {
      beginSelfieStep();
    }
  }

  function renderRaw(value, meta) {
    els.resultBox.style.display='block';
    els.resultText.textContent=value;
    els.sourceLabel.textContent = meta.source || 'unknown';
    els.timeLabel.textContent = new Date().toLocaleTimeString();
    if (isLikelyURL(value)) {
      els.urlLine.style.display='block';
      els.resultLink.textContent=value;
      els.resultLink.href=value;
    } else {
      els.urlLine.style.display='none';
      els.resultLink.removeAttribute('href');
    }
  }

  function greet(value) {
    const key = value.toUpperCase();
    const name = USER_CODES[key];
    if (!name) {
      els.greetingBox.style.display='none';
      return false;
    }
    const repeat = state.greetedCodes.has(key);
    state.greetedCodes.add(key);
    els.greetingMsg.textContent = `WELCOME BACK, ${name}!`;
    els.greetingMeta.textContent = `Code: ${key} • ${new Date().toLocaleTimeString()}${repeat?' (repeat)':''}`;
    els.greetingBox.classList.add('ok','pulse');
    els.greetingBox.style.display='block';
    setTimeout(()=>els.greetingBox.classList.remove('pulse'), 1500);
    return true;
  }

  /*********** SELFIE ***********/
  function beginSelfieStep() {
    state.selfieStage='awaiting';
    els.selfieSection.style.display='block';
    els.captureBtn.disabled=false;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfiePreview.style.display='none';
  }

  function captureSelfie() {
    if (!state.stream) return alert('Camera not active.');
    if (state.selfieStage!=='awaiting' && state.selfieStage!=='captured') return;
    const v=els.video;
    const vw=v.videoWidth, vh=v.videoHeight;
    const side = Math.min(vw,vh);
    const sx=(vw - side)/2, sy=(vh - side)/2;
    const off=document.createElement('canvas');
    off.width=side; off.height=side;
    off.getContext('2d').drawImage(v,sx,sy,side,side,0,0,side,side);
    state.selfieDataUrl = off.toDataURL('image/jpeg', 0.92);
    els.selfiePreview.src = state.selfieDataUrl;
    els.selfiePreview.style.display='block';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=false;
    els.submitSelfieBtn.disabled=false;
    state.selfieStage='captured';
    els.selfieInstruction.textContent='Review your selfie. Submit or retake.';
  }

  function retakeSelfie() {
    if (state.selfieStage!=='captured') return;
    state.selfieDataUrl=null;
    els.selfiePreview.style.display='none';
    els.captureBtn.disabled=false;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent='Please take a selfie to continue.';
  }

  function submitSelfie() {
    if (state.selfieStage!=='captured') return;
    state.selfieStage='completed';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Selfie submitted.';
    grantEntry();
  }

  /*********** ENTRY + RESET ***********/
  function grantEntry() {
    els.entryBox.style.display='block';
    els.entryMsg.style.display='block';
    els.entryMsg.textContent='PLEASE, COME IN!';
    els.entryMeta.textContent='Entry granted at ' + new Date().toLocaleTimeString();
    if (state.running && !state.paused) pauseResume();
    scheduleAutoReset();
  }

  function scheduleAutoReset() {
    clearResetTimers();
    state.resetRemainingSec = Math.round(AUTO_RESET_DELAY_MS/1000);
    els.resetCountdown.style.display='block';
    els.resetCountdown.textContent='Auto reset to Step 1 in '+state.resetRemainingSec+'s...';
    els.restartBtn.style.display='inline-block';
    state.resetCountdownId = setInterval(()=>{
      state.resetRemainingSec--;
      if (state.resetRemainingSec <=0) {
        clearResetTimers();
        resetToStep1();
      } else {
        els.resetCountdown.textContent='Auto reset to Step 1 in '+state.resetRemainingSec+'s...';
      }
    },1000);
    state.resetTimerId = setTimeout(()=>{
      clearResetTimers();
      resetToStep1();
    }, AUTO_RESET_DELAY_MS);
  }

  function clearResetTimers() {
    if (state.resetTimerId) clearTimeout(state.resetTimerId);
    if (state.resetCountdownId) clearInterval(state.resetCountdownId);
    state.resetTimerId = state.resetCountdownId = null;
  }

  function resetToStep1() {
    stop();
    clearResetTimers();
    [els.greetingBox, els.selfieSection, els.entryBox, els.resultBox].forEach(p=>p.style.display='none');
    els.resetCountdown.style.display='none';
    els.restartBtn.style.display='none';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfiePreview.style.display='none';
    els.selfieInstruction.textContent='Hi JANE DOE, please take a selfie to continue.';
    state.lastValue=null;
    state.greetedCodes.clear();
    state.selfieStage='idle';
    state.selfieDataUrl=null;
    els.methodIndicator.textContent='';
    setBadge('Idle',null);
  }

  /*********** VISUAL HIGHLIGHT ***********/
  function highlight(meta) {
    const ctx = els.canvas.getContext('2d');
    ctx.clearRect(0,0,els.canvas.width,els.canvas.height);
    if (!meta.location){
      flashCanvas();
      return;
    }
    ctx.save();
    ctx.strokeStyle='#16a34a';
    ctx.lineWidth=3;
    const pts = [
      meta.location.topLeftCorner,
      meta.location.topRightCorner,
      meta.location.bottomRightCorner,
      meta.location.bottomLeftCorner
    ];
    ctx.beginPath();
    pts.forEach((p,i)=> i? ctx.lineTo(p.x,p.y): ctx.moveTo(p.x,p.y));
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
    flashCanvas();
  }
  function flashCanvas() {
    els.canvas.style.opacity=.9;
    setTimeout(()=>els.canvas.style.opacity=0,220);
  }

  /*********** MISC ***********/
  document.addEventListener('visibilitychange',()=>{
    if (document.hidden && state.running && !state.paused) pauseResume();
  });

  // Events
  els.startBtn.addEventListener('click', start);
  els.stopBtn.addEventListener('click', stop);
  els.pauseBtn.addEventListener('click', pauseResume);
  els.restartBtn.addEventListener('click', resetToStep1);
  els.captureBtn.addEventListener('click', captureSelfie);
  els.retakeBtn.addEventListener('click', retakeSelfie);
  els.submitSelfieBtn.addEventListener('click', submitSelfie);

  // Init
  initDetector().catch(()=>setBadge('Init error','err'));

  // Expose for debugging
  window.__qrState = state;
})();
</script>
</body>
</html>
