<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Code Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    color-scheme: light dark;
    --bg:#0f172a;
    --panel:#1e293b;
    --accent:#2563eb;
    --ok:#16a34a;
    --err:#dc2626;
    --warn:#d97706;
    --focus:#93c5fd;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    min-height:100svh;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(circle at 30% 20%,#1e293b,#0f172a 70%);
    color:#f1f5f9;
    padding:1.25rem;
  }
  main{
    width:100%;
    max-width:540px;
    display:flex;
    flex-direction:column;
    gap:1rem;
    text-align:center;
  }
  h1{margin:0 0 .25rem;font-size:clamp(1.55rem,4.5vw,2.35rem);letter-spacing:.5px;}
  .scanner-shell{
    position:relative;
    width:100%;
    max-width:500px;
    aspect-ratio:1/1;
    background:#000;
    border:2px solid #334155;
    border-radius:1rem;
    overflow:hidden;
    margin:0 auto;
    display:flex;
    align-items:center;
    justify-content:center;
    touch-action:none;
  }
  video{
    width:100%;height:100%;object-fit:cover;
    display:none;
    transform:scaleX(-1);
  }
  canvas{
    position:absolute;inset:0;
    width:100%;height:100%;
    pointer-events:none;
    opacity:0;
    transition:opacity .18s ease;
  }
  .overlay{position:absolute;inset:0;pointer-events:none;}
  .overlay::before{
    content:"";position:absolute;inset:0;
    background:radial-gradient(circle at center,rgba(0,0,0,0) 60%,rgba(0,0,0,.55) 82%);
  }
  .frame-corner{
    position:absolute;width:2.3rem;height:2.3rem;
    border:4px solid var(--accent);
    filter:drop-shadow(0 0 4px var(--accent));
  }
  .frame-corner.tl{top:10%;left:10%;border-right:0;border-bottom:0;}
  .frame-corner.tr{top:10%;right:10%;border-left:0;border-bottom:0;}
  .frame-corner.bl{bottom:10%;left:10%;border-right:0;border-top:0;}
  .frame-corner.br{bottom:10%;right:10%;border-left:0;border-top:0;}
  button{
    font:inherit;padding:.75rem 1.1rem;border-radius:.8rem;
    border:1px solid #475569;background:linear-gradient(#2563eb,#1d4ed8);
    color:#fff;cursor:pointer;font-weight:600;letter-spacing:.4px;
    transition:background .25s,transform .15s;
  }
  button:hover:not(:disabled){background:linear-gradient(#3b82f6,#2563eb);}
  button:focus-visible{outline:3px solid var(--focus);outline-offset:2px;}
  button:active:not(:disabled){transform:translateY(2px);}
  button:disabled{opacity:.55;cursor:not-allowed;}
  .badge{padding:.25rem .6rem;border-radius:1rem;background:#334155;font-weight:500;font-size:.7rem;}
  .badge.ok{background:var(--ok);color:#fff;}
  .badge.err{background:var(--err);color:#fff;}
  .badge.warn{background:var(--warn);color:#fff;}
  .status{min-height:1.3rem;font-size:.7rem;display:flex;gap:.4rem;flex-wrap:wrap;justify-content:center;}
  .panel{
    background:var(--panel);
    padding:.95rem 1.05rem;
    border:1px solid #334155;
    border-radius:.95rem;
    font-size:.9rem;
    text-align:left;
    word-break:break-word;
    display:none;
  }
  .panel.centered{text-align:center;}
  .greeting-msg{font-size:1.2rem;margin:.1rem 0 .4rem;font-weight:700;letter-spacing:.5px;}
  .entry-msg{font-size:1.45rem;margin:.8rem 0 0;font-weight:800;letter-spacing:1px;color:var(--ok);}
  #selfiePreview{max-width:100%;border-radius:.75rem;border:2px solid #334155;display:none;margin-top:.65rem;}
  .selfie-actions{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:center;margin-top:.75rem;}
  .note{font-size:.7rem;opacity:.65;margin-top:.5rem;}
  footer{margin-top:.75rem;font-size:.6rem;opacity:.55;}
  .pulse{animation:pulse 1.1s ease-in-out 2;}
  @keyframes pulse{0%{transform:scale(1);}40%{transform:scale(1.045);}100%{transform:scale(1);}}
  .countdown{font-size:.65rem;opacity:.7;margin-top:.6rem;}
  .hidden{display:none !important;}
  .method-indicator{font-size:.6rem;opacity:.6;margin-top:.2rem;}
</style>
</head>
<body>
<main>
  <header><h1>QR Scanner</h1></header>

  <!-- Scanner area -->
  <div class="scanner-shell" id="scannerShell">
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div class="overlay" aria-hidden="true">
      <div class="frame-corner tl"></div>
      <div class="frame-corner tr"></div>
      <div class="frame-corner bl"></div>
      <div class="frame-corner br"></div>
    </div>
    <div id="placeholderMsg" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.9rem;opacity:.75;padding:1rem;text-align:center;">
      Tap Start Scan.
    </div>
  </div>

  <!-- ONLY ONE BUTTON -->
  <div>
    <button id="startBtn" type="button">Start Scan</button>
  </div>

  <div class="status">
    <span class="badge" id="envBadge">Idle</span>
  </div>
  <div class="method-indicator" id="methodIndicator"></div>

  <!-- Greeting -->
  <section class="panel centered" id="greetingBox" aria-live="assertive">
    <p class="greeting-msg" id="greetingMsg"></p>
    <p id="greetingMeta" style="margin:0;font-size:.65rem;opacity:.65;"></p>
  </section>

  <!-- Step 3: Selfie -->
  <section class="panel centered" id="selfieSection" aria-label="Selfie verification">
    <h2 style="margin:0 0 .4rem;font-size:1rem;">Step 3: Selfie Verification</h2>
    <p id="selfieInstruction" style="margin:.15rem 0 .6rem;font-size:.8rem;opacity:.9;">
      Hi JANE DOE, please take a selfie to continue.
    </p>
    <img id="selfiePreview" alt="Selfie preview" />
    <div class="selfie-actions">
      <button id="captureBtn" type="button" disabled>Capture Selfie</button>
      <button id="retakeBtn" type="button" disabled>Retake</button>
      <button id="submitSelfieBtn" type="button" disabled>Submit</button>
    </div>
    <p class="note">Image stays only in this session (not uploaded).</p>
    <p class="entry-msg" id="entryMsg" style="display:none;">PLEASE, COME IN!</p>
    <p class="countdown" id="resetCountdown" style="display:none;"></p>
  </section>

  <!-- Raw result (debug) -->
  <section class="panel" id="resultBox" aria-label="Raw scan result">
    <h2 style="margin:0 0 .4rem;">Raw Result</h2>
    <div><strong>Value:</strong> <span id="resultText"></span></div>
    <div id="urlLine" style="display:none;margin-top:.35rem;">URL:
      <a id="resultLink" target="_blank" rel="noopener noreferrer"></a>
    </div>
    <div style="margin-top:.5rem;font-size:.6rem;opacity:.6;">
      Source: <code class="inline" id="sourceLabel"></code> • Time:
      <code class="inline" id="timeLabel"></code>
    </div>
  </section>

  <footer>Scan → Greet → (Selfie if JANE DOE) → PLEASE, COME IN! → Auto reset in 60s.</footer>
</main>

<!-- jsQR (fallback / main if BarcodeDetector absent) -->
<script defer src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"
 integrity="sha384-rC5NcI3F9zeJq82cC28hvMmjr4neTJD7sPXQf8zl9uG6MS5Icnvx8e3UgFF3Rdg6"
 crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
;(() => {
  "use strict";

  /******** CONFIG ********/
  const USER_CODES = {
    "3OE0C1KD": "JOHN SMITH",
    "CKR9WLDM": "JANE DOE"
  };
  const SELFIE_CODE = "CKR9WLDM";
  const AUTO_RESET_MS = 60000; // 60s
  const THROTTLE_MS = 900;
  /************************/

  const els = {
    shell: document.getElementById('scannerShell'),
    video: document.getElementById('video'),
    canvas: document.getElementById('canvas'),
    startBtn: document.getElementById('startBtn'),
    placeholder: document.getElementById('placeholderMsg'),
    envBadge: document.getElementById('envBadge'),
    methodIndicator: document.getElementById('methodIndicator'),
    greetingBox: document.getElementById('greetingBox'),
    greetingMsg: document.getElementById('greetingMsg'),
    greetingMeta: document.getElementById('greetingMeta'),
    selfieSection: document.getElementById('selfieSection'),
    selfieInstruction: document.getElementById('selfieInstruction'),
    selfiePreview: document.getElementById('selfiePreview'),
    captureBtn: document.getElementById('captureBtn'),
    retakeBtn: document.getElementById('retakeBtn'),
    submitSelfieBtn: document.getElementById('submitSelfieBtn'),
    entryMsg: document.getElementById('entryMsg'),
    resetCountdown: document.getElementById('resetCountdown'),
    resultBox: document.getElementById('resultBox'),
    resultText: document.getElementById('resultText'),
    urlLine: document.getElementById('urlLine'),
    resultLink: document.getElementById('resultLink'),
    sourceLabel: document.getElementById('sourceLabel'),
    timeLabel: document.getElementById('timeLabel')
  };

  const state = {
    running:false,
    stream:null,
    detector:null,
    decodeMode:'auto',
    scanning:false,
    lastValue:null,
    lastScanTs:0,
    rafId:null,
    selfieStage:'idle', // idle | awaiting | captured | completed
    selfieData:null,
    resetTimer:null,
    countdownTimer:null,
    countdownRemaining:0
  };

  function setBadge(text, level){
    els.envBadge.textContent = text;
    els.envBadge.className = 'badge' + (level ? ' '+level : '');
  }

  async function initDetector() {
    if ('BarcodeDetector' in window) {
      try {
        const fmts = await BarcodeDetector.getSupportedFormats();
        if (fmts.includes('qr_code')) {
          state.detector = new BarcodeDetector({formats:['qr_code']});
          state.decodeMode = 'barcode';
          setBadge('Ready (BarcodeDetector)', 'ok');
          return;
        }
      } catch(e){ console.warn('BarcodeDetector init failed', e); }
    }
    state.decodeMode='jsQR';
    setBadge('Ready (jsQR)', 'warn');
  }

  async function startScan() {
    if (state.running) return;
    resetAll(); // ensure clean
    try {
      state.stream = await navigator.mediaDevices.getUserMedia({
        video:{
          facingMode:{ideal:'user'}, // front camera preference
          width:{ideal:1280},
          height:{ideal:1280},
          aspectRatio:1
        },
        audio:false
      });
    } catch(e){
      console.error(e);
      if (location.protocol !== 'https:') {
        alert('Camera requires HTTPS (or localhost).');
      }
      setBadge('Camera denied','err');
      return;
    }
    els.video.srcObject = state.stream;
    await els.video.play();
    els.video.style.display='block';
    els.placeholder.style.display='none';
    state.running=true;
    els.startBtn.disabled=true;
    setBadge('Scanning ('+state.decodeMode+')','ok');
    loop();
  }

  function stopCamera() {
    state.running=false;
    cancelAnimationFrame(state.rafId);
    if (state.stream) state.stream.getTracks().forEach(t=>t.stop());
    state.stream=null;
    els.video.srcObject=null;
    els.video.style.display='none';
    els.placeholder.style.display='flex';
    els.startBtn.disabled=false;
    setBadge('Stopped','warn');
  }

  function hideScannerUI() {
    els.shell.classList.add('hidden');
    els.startBtn.classList.add('hidden');
  }
  function showScannerUI() {
    els.shell.classList.remove('hidden');
    els.startBtn.classList.remove('hidden');
  }

  function loop() {
    if (!state.running) return;
    state.rafId = requestAnimationFrame(loop);
    if (state.scanning) return;
    state.scanning=true;

    if (state.detector && state.decodeMode==='barcode') {
      state.detector.detect(els.video)
        .then(codes=>{
          if (codes && codes.length) {
            handleResult(codes[0].rawValue,{source:'BarcodeDetector'});
          } else {
            tryJsQR().finally(()=> state.scanning=false);
          }
        })
        .catch(()=>{
          state.decodeMode='jsqr';
          setBadge('Fallback jsQR','warn');
          tryJsQR().finally(()=>state.scanning=false);
        });
    } else {
      tryJsQR().finally(()=>state.scanning=false);
    }
  }

  function tryJsQR() {
    return new Promise(resolve=>{
      if (!window.jsQR) return resolve();
      const ctx = els.canvas.getContext('2d',{willReadFrequently:true});
      const v = els.video;
      const vw = v.videoWidth, vh = v.videoHeight;
      if (!vw || !vh) return resolve();
      const side = Math.min(vw,vh);
      const sx=(vw-side)/2, sy=(vh-side)/2;
      els.canvas.width=side; els.canvas.height=side;
      ctx.drawImage(v,sx,sy,side,side,0,0,side,side);
      const img = ctx.getImageData(0,0,side,side);
      const qr = jsQR(img.data,img.width,img.height,{inversionAttempts:'attemptBoth'});
      if (qr) {
        handleResult(qr.data,{source:'jsQR', location:qr.location});
      }
      resolve();
    });
  }

  function handleResult(raw, meta){
    const value = (''+raw).trim();
    if (!value) return;
    const now = performance.now();
    if (value === state.lastValue && (now - state.lastScanTs) < THROTTLE_MS) return;
    state.lastValue=value;
    state.lastScanTs=now;

    els.methodIndicator.textContent='Decoded via: '+(meta.source||'unknown');
    highlight(meta.location);

    showRaw(value, meta);
    const code = value.toUpperCase();
    const name = USER_CODES[code];
    if (!name) return;

    // Show greeting
    els.greetingMsg.textContent = `WELCOME BACK, ${name}!`;
    els.greetingMeta.textContent = `Code: ${code} • ${new Date().toLocaleTimeString()}`;
    els.greetingBox.style.display='block';
    els.greetingBox.classList.add('pulse');
    setTimeout(()=>els.greetingBox.classList.remove('pulse'),1100);

    // Hide scanner & button
    hideScannerUI();

    if (code === SELFIE_CODE) {
      // Keep stream active for selfie capture (video hidden but usable)
      startSelfie(name);
    } else {
      // No selfie required
      stopCamera();
      scheduleReset();
    }
  }

  function showRaw(value, meta){
    els.resultBox.style.display='block';
    els.resultText.textContent=value;
    els.sourceLabel.textContent=meta.source||'unknown';
    els.timeLabel.textContent=new Date().toLocaleTimeString();
    if (/^https?:\/\/\S+$/i.test(value)){
      els.urlLine.style.display='block';
      els.resultLink.textContent=value;
      els.resultLink.href=value;
    } else {
      els.urlLine.style.display='none';
      els.resultLink.removeAttribute('href');
    }
  }

  /******** Selfie Flow ********/
  function startSelfie(name){
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent=`Hi ${name}, please take a selfie to continue.`;
    els.captureBtn.disabled=false;
    els.selfieSection.style.display='block';
  }

  function captureSelfie(){
    if (state.selfieStage!=='awaiting' && state.selfieStage!=='captured') return;
    if (!state.stream) return alert('Camera not active.');
    const v=els.video, vw=v.videoWidth, vh=v.videoHeight;
    const side=Math.min(vw,vh);
    const sx=(vw-side)/2, sy=(vh-side)/2;
    const off=document.createElement('canvas');
    off.width=side; off.height=side;
    off.getContext('2d').drawImage(v,sx,sy,side,side,0,0,side,side);
    state.selfieData=off.toDataURL('image/jpeg',0.9);
    els.selfiePreview.src=state.selfieData;
    els.selfiePreview.style.display='block';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=false;
    els.submitSelfieBtn.disabled=false;
    state.selfieStage='captured';
    els.selfieInstruction.textContent='Review your selfie. Submit or retake.';
  }

  function retakeSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieData=null;
    els.selfiePreview.style.display='none';
    els.captureBtn.disabled=false;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent='Please take a selfie to continue.';
  }

  function submitSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieStage='completed';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Selfie submitted.';
    els.entryMsg.style.display='block';
    stopCamera();          // privacy: stop stream after selfie
    scheduleReset();
  }

  /******** Reset ********/
  function scheduleReset(){
    clearResetTimers();
    state.countdownRemaining = Math.round(AUTO_RESET_MS/1000);
    els.resetCountdown.style.display='block';
    els.resetCountdown.textContent='Resetting in '+state.countdownRemaining+'s...';
    state.countdownTimer = setInterval(()=>{
      state.countdownRemaining--;
      if (state.countdownRemaining <= 0) {
        resetAll();
      } else {
        els.resetCountdown.textContent='Resetting in '+state.countdownRemaining+'s...';
      }
    },1000);
    state.resetTimer = setTimeout(resetAll, AUTO_RESET_MS);
  }

  function clearResetTimers(){
    if (state.resetTimer) clearTimeout(state.resetTimer);
    if (state.countdownTimer) clearInterval(state.countdownTimer);
    state.resetTimer=null;
    state.countdownTimer=null;
  }

  function resetAll(){
    clearResetTimers();
    stopCamera();
    // hide panels
    [els.greetingBox, els.selfieSection, els.resultBox].forEach(p=>p.style.display='none');
    els.entryMsg.style.display='none';
    els.selfiePreview.style.display='none';
    els.resetCountdown.style.display='none';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Hi JANE DOE, please take a selfie to continue.';
    state.lastValue=null;
    state.selfieStage='idle';
    state.selfieData=null;
    showScannerUI();
    setBadge('Idle');
    els.methodIndicator.textContent='';
  }

  /******** Visual Highlight ********/
  function highlight(location){
    const ctx=els.canvas.getContext('2d');
    ctx.clearRect(0,0,els.canvas.width,els.canvas.height);
    if (!location){
      flashCanvas();
      return;
    }
    ctx.save();
    ctx.strokeStyle='#16a34a';
    ctx.lineWidth=3;
    const pts=[location.topLeftCorner,location.topRightCorner,location.bottomRightCorner,location.bottomLeftCorner];
    if (pts.every(Boolean)) {
      ctx.beginPath();
      pts.forEach((p,i)=> i? ctx.lineTo(p.x,p.y): ctx.moveTo(p.x,p.y));
      ctx.closePath();
      ctx.stroke();
    }
    ctx.restore();
    flashCanvas();
  }
  function flashCanvas(){
    els.canvas.style.opacity=.9;
    setTimeout(()=>els.canvas.style.opacity=0,220);
  }

  /******** Events ********/
  els.startBtn.addEventListener('click', startScan);
  els.captureBtn.addEventListener('click', captureSelfie);
  els.retakeBtn.addEventListener('click', retakeSelfie);
  els.submitSelfieBtn.addEventListener('click', submitSelfie);

  document.addEventListener('visibilitychange',()=>{
    if (document.hidden) stopCamera();
  });

  // Initialize
  initDetector();

  // Expose for quick debugging
  window.__qrState = state;
})();
</script>
</body>
</html>
