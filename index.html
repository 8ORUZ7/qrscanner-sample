<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>QR Code Scanner</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    color-scheme: light dark;
    --bg:#0f172a; --panel:#1e293b; --accent:#2563eb;
    --ok:#16a34a; --err:#dc2626; --warn:#d97706; --focus:#93c5fd;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;min-height:100svh;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(circle at 30% 20%,#1e293b,#0f172a 70%);
    color:#f1f5f9;padding:1.25rem;
  }
  main{width:100%;max-width:560px;display:flex;flex-direction:column;gap:1rem;text-align:center;}
  h1{margin:0 0 .45rem;font-size:clamp(1.6rem,4.8vw,2.45rem);letter-spacing:.5px;}
  .step-indicator{font-size:.7rem;letter-spacing:.55px;text-transform:uppercase;opacity:.75;}
  .scanner-shell{
    position:relative;width:100%;max-width:520px;aspect-ratio:1/1;
    background:#000;border:2px solid #334155;border-radius:1rem;overflow:hidden;
    margin:0 auto;display:flex;align-items:center;justify-content:center;
  }
  video{
    width:100%;height:100%;object-fit:cover;display:none;transform:scaleX(-1);
  }
  canvas{
    position:absolute;inset:0;width:100%;height:100%;pointer-events:none;
    opacity:0;transition:opacity .18s ease;
  }
  .overlay{position:absolute;inset:0;pointer-events:none;}
  .overlay::before{
    content:"";position:absolute;inset:0;
    background:radial-gradient(circle at center,rgba(0,0,0,0) 60%,rgba(0,0,0,.55) 82%);
  }
  .frame-corner{
    position:absolute;width:2.3rem;height:2.3rem;border:4px solid var(--accent);
    filter:drop-shadow(0 0 4px var(--accent));
  }
  .frame-corner.tl{top:10%;left:10%;border-right:0;border-bottom:0;}
  .frame-corner.tr{top:10%;right:10%;border-left:0;border-bottom:0;}
  .frame-corner.bl{bottom:10%;left:10%;border-right:0;border-top:0;}
  .frame-corner.br{bottom:10%;right:10%;border-left:0;border-top:0;}
  button{
    font:inherit;padding:.8rem 1.2rem;border-radius:.85rem;border:1px solid #475569;
    background:linear-gradient(#2563eb,#1d4ed8);color:#fff;font-weight:600;letter-spacing:.45px;
    cursor:pointer;transition:background .25s,transform .15s;
  }
  button:hover:not(:disabled){background:linear-gradient(#3b82f6,#2563eb);}
  button:focus-visible{outline:3px solid var(--focus);outline-offset:2px;}
  button:active:not(:disabled){transform:translateY(2px);}
  button:disabled{opacity:.55;cursor:not-allowed;}
  .badge{padding:.3rem .7rem;border-radius:1rem;background:#334155;font-weight:500;font-size:.65rem;}
  .badge.ok{background:var(--ok);color:#fff;}
  .badge.err{background:var(--err);color:#fff;}
  .badge.warn{background:var(--warn);color:#fff;}
  .status{min-height:1.2rem;display:flex;gap:.45rem;justify-content:center;flex-wrap:wrap;}
  .panel{
    background:var(--panel);padding:1rem 1.15rem;border:1px solid #334155;border-radius:1rem;
    font-size:.9rem;text-align:left;word-break:break-word;display:none;
  }
  .panel.centered{text-align:center;}
  .greeting-msg{font-size:1.35rem;margin:.2rem 0 .55rem;font-weight:760;letter-spacing:.65px;}
  .entry-msg{font-size:1.55rem;margin:1rem 0 0;font-weight:800;letter-spacing:1px;color:var(--ok);}
  #selfiePreview{
    max-width:100%;border-radius:.85rem;border:2px solid #334155;display:none;margin-top:.7rem;
  }
  .selfie-actions{display:flex;gap:.65rem;flex-wrap:wrap;justify-content:center;margin-top:.8rem;}
  .note{font-size:.65rem;opacity:.6;margin-top:.6rem;}
  footer{margin-top:.9rem;font-size:.6rem;opacity:.55;}
  .pulse{animation:pulse 1.15s ease-in-out 2;}
  @keyframes pulse{0%{transform:scale(1);}40%{transform:scale(1.045);}100%{transform:scale(1);}}
  .countdown{font-size:.75rem;opacity:.8;margin-top:.7rem;}
  .method-indicator{font-size:.55rem;opacity:.55;margin-top:.3rem;}
  .hidden{display:none !important;}
  a.inline-reset{color:var(--accent);cursor:pointer;font-size:.65rem;text-decoration:none;margin-left:.45rem;}
  a.inline-reset:hover{text-decoration:underline;}
</style>
</head>
<body>
<main>
  <h1>QR Access</h1>
  <div id="currentStep" class="step-indicator">Ready</div>

  <!-- Scanner (hidden after successful scan) -->
  <div class="scanner-shell" id="scannerShell" aria-label="QR scanner viewport">
    <video id="video" playsinline muted></video>
    <canvas id="canvas" aria-hidden="true"></canvas>
    <div class="overlay" aria-hidden="true">
      <div class="frame-corner tl"></div>
      <div class="frame-corner tr"></div>
      <div class="frame-corner bl"></div>
      <div class="frame-corner br"></div>
    </div>
    <div id="placeholderMsg"
      style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.95rem;opacity:.75;padding:1rem;text-align:center;">
      Tap Start Scan.
    </div>
  </div>

  <!-- Single start button -->
  <div>
    <button id="startBtn" type="button">Start Scan</button>
  </div>

  <div class="status"><span class="badge" id="envBadge">Idle</span></div>
  <div class="method-indicator" id="methodIndicator"></div>

  <!-- Step 2 Greeting -->
  <section class="panel centered" id="greetingBox" aria-live="assertive">
    <div style="font-size:.65rem;opacity:.65;margin:0 0 .4rem;">Greeting</div>
    <p class="greeting-msg" id="greetingMsg"></p>
    <p id="greetingMeta" style="margin:0;font-size:.65rem;opacity:.65;"></p>
  </section>

  <!-- Step 3 Selfie -->
  <section class="panel centered" id="selfieSection" aria-label="Selfie verification">
    <div style="font-size:.65rem;opacity:.65;margin:0 0 .45rem;">Selfie Verification</div>
    <p id="selfieInstruction" style="margin:.2rem 0 .65rem;font-size:.82rem;opacity:.9;">
      Please take a selfie to continue.
    </p>

    <!-- The video element used for capture is hidden with the scanner, but still streaming.
         We optionally show a captured still below. -->
    <img id="selfiePreview" alt="Selfie preview" />

    <div class="selfie-actions">
      <button id="captureBtn" type="button" disabled>Capture Selfie</button>
      <button id="retakeBtn" type="button" disabled>Retake</button>
      <button id="submitSelfieBtn" type="button" disabled>Submit</button>
    </div>
    <p class="note">Selfie stays only on this device (not uploaded).</p>

    <p class="entry-msg" id="entryMsg" style="display:none;">Please Come IN</p>
    <p class="countdown" id="resetCountdown" style="display:none;"></p>
  </section>

  <footer>Flow: Start → Greeting → Selfie → Auto Reset (60s)</footer>
</main>

<!-- jsQR fallback (if BarcodeDetector not available) -->
<script defer src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"
 integrity="sha384-rC5NcI3F9zeJq82cC28hvMmjr4neTJD7sPXQf8zl9uG6MS5Icnvx8e3UgFF3Rdg6"
 crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
;(() => {
  "use strict";

  /******** CONFIG ********/
  const USER_CODES = {
    "3OE0C1KD": "JOHN SMITH",
    "CKR9WLDM": "JANE DOE"
  };
  const AUTO_RESET_MS = 60000;          // 60 seconds
  const THROTTLE_MS   = 900;
  /************************/

  const els = {
    step: document.getElementById('currentStep'),
    shell: document.getElementById('scannerShell'),
    video: document.getElementById('video'),
    canvas: document.getElementById('canvas'),
    startBtn: document.getElementById('startBtn'),
    placeholder: document.getElementById('placeholderMsg'),
    envBadge: document.getElementById('envBadge'),
    methodIndicator: document.getElementById('methodIndicator'),
    greetingBox: document.getElementById('greetingBox'),
    greetingMsg: document.getElementById('greetingMsg'),
    greetingMeta: document.getElementById('greetingMeta'),
    selfieSection: document.getElementById('selfieSection'),
    selfieInstruction: document.getElementById('selfieInstruction'),
    selfiePreview: document.getElementById('selfiePreview'),
    captureBtn: document.getElementById('captureBtn'),
    retakeBtn: document.getElementById('retakeBtn'),
    submitSelfieBtn: document.getElementById('submitSelfieBtn'),
    entryMsg: document.getElementById('entryMsg'),
    resetCountdown: document.getElementById('resetCountdown')
  };

  const state = {
    running:false,
    stream:null,
    detector:null,
    decodeMode:'auto',
    scanning:false,
    lastValue:null,
    lastScanTs:0,
    rafId:null,
    selfieStage:'idle', // idle | awaiting | captured | completed
    selfieData:null,
    resetTimer:null,
    countdownTimer:null,
    countdownRemaining:0
  };

  const setBadge = (t,l)=>{ els.envBadge.textContent=t; els.envBadge.className='badge'+(l?' '+l:''); };
  const setStep = t => els.step.textContent = t;

  /******** Initialization ********/
  async function initDetector(){
    if ('BarcodeDetector' in window) {
      try {
        const fmts = await BarcodeDetector.getSupportedFormats();
        if (fmts.includes('qr_code')) {
          state.detector = new BarcodeDetector({formats:['qr_code']});
          state.decodeMode='barcode';
          setBadge('Ready (BarcodeDetector)','ok');
          return;
        }
      } catch(e){ console.warn('BarcodeDetector init failed', e); }
    }
    state.decodeMode='jsQR';
    setBadge('Ready (jsQR)','warn');
  }

  /******** Start Scan ********/
  async function startScan(){
    if (state.running) return;
    resetAll(); // start clean
    setStep('Step 1: Starting camera');
    try {
      state.stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'user'}, width:{ideal:1280}, height:{ideal:1280}, aspectRatio:1 },
        audio:false
      });
    } catch(e){
      console.error(e);
      if (location.protocol!=='https:') alert('Camera requires HTTPS or localhost.');
      setBadge('Camera denied','err');
      setStep('Step 1: Camera error');
      return;
    }
    els.video.srcObject = state.stream;
    await els.video.play();
    els.video.style.display='block';
    els.placeholder.style.display='none';
    state.running=true;
    els.startBtn.disabled=true;
    setBadge('Scanning ('+state.decodeMode+')','ok');
    setStep('Step 2: Scan a QR Code');
    loop();
  }

  /******** Scan Loop ********/
  function loop(){
    if (!state.running) return;
    state.rafId = requestAnimationFrame(loop);
    if (state.scanning) return;
    state.scanning=true;

    if (state.detector && state.decodeMode==='barcode'){
      state.detector.detect(els.video)
        .then(codes=>{
          if (codes && codes.length){
            handleResult(codes[0].rawValue,{source:'BarcodeDetector'});
          } else {
            tryJsQR().finally(()=> state.scanning=false);
          }
        })
        .catch(()=>{
          state.decodeMode='jsQR';
            setBadge('Fallback jsQR','warn');
            tryJsQR().finally(()=> state.scanning=false);
        });
    } else {
      tryJsQR().finally(()=> state.scanning=false);
    }
  }

  function tryJsQR(){
    return new Promise(resolve=>{
      if (!window.jsQR) return resolve();
      const ctx=els.canvas.getContext('2d',{willReadFrequently:true});
      const v=els.video, vw=v.videoWidth, vh=v.videoHeight;
      if (!vw || !vh) return resolve();
      const side=Math.min(vw,vh);
      const sx=(vw-side)/2, sy=(vh-side)/2;
      els.canvas.width=side; els.canvas.height=side;
      ctx.drawImage(v,sx,sy,side,side,0,0,side,side);
      const img=ctx.getImageData(0,0,side,side);
      const qr=jsQR(img.data,img.width,img.height,{inversionAttempts:'attemptBoth'});
      if(qr) handleResult(qr.data,{source:'jsQR',location:qr.location});
      resolve();
    });
  }

  /******** Handle Result ********/
  function handleResult(raw, meta){
    const value=(''+raw).trim();
    if (!value) return;
    const now=performance.now();
    if (value===state.lastValue && (now - state.lastScanTs) < THROTTLE_MS) return;
    state.lastValue=value;
    state.lastScanTs=now;
    els.methodIndicator.textContent='Decoded via: '+(meta.source||'unknown');
    highlight(meta.location);

    const code=value.toUpperCase();
    const name=USER_CODES[code];
    if (!name) return;

    // Stop scanning loop, but keep stream active (video hidden after we hide scanner)
    state.running=false;
    cancelAnimationFrame(state.rafId);

    // HIDE scanner UI & start button immediately
    hideScannerUI();

    // Step 2 Greeting
    els.greetingMsg.textContent=`Welcome ${name}!`;
    els.greetingMeta.textContent=`Code: ${code} • ${new Date().toLocaleTimeString()}`;
    els.greetingBox.style.display='block';
    els.greetingBox.classList.add('pulse');
    setTimeout(()=>els.greetingBox.classList.remove('pulse'),1100);
    setStep('Step 2: Greeting');

    // Proceed to Step 3 Selfie for all recognized codes
    startSelfie(name);
  }

  /******** Selfie (Step 3) ********/
  function startSelfie(name){
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent=`Please take a selfie to continue, ${name}.`;
    els.captureBtn.disabled=false;
    els.selfieSection.style.display='block';
    setStep('Step 3: Selfie Verification');
    setTimeout(()=>els.selfieSection.scrollIntoView({behavior:'smooth',block:'center'}),60);
  }

  function captureSelfie(){
    if (!['awaiting','captured'].includes(state.selfieStage)) return;
    if (!state.stream) return alert('Camera not active.');
    const v=els.video, vw=v.videoWidth, vh=v.videoHeight;
    const side=Math.min(vw,vh);
    const sx=(vw-side)/2, sy=(vh-side)/2;
    const off=document.createElement('canvas');
    off.width=side; off.height=side;
    off.getContext('2d').drawImage(v,sx,sy,side,side,0,0,side,side);
    state.selfieData=off.toDataURL('image/jpeg',0.9);
    els.selfiePreview.src=state.selfieData;
    els.selfiePreview.style.display='block';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=false;
    els.submitSelfieBtn.disabled=false;
    state.selfieStage='captured';
    els.selfieInstruction.textContent='Review your selfie. Submit or retake.';
  }

  function retakeSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieData=null;
    els.selfiePreview.style.display='none';
    els.captureBtn.disabled=false;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    state.selfieStage='awaiting';
    els.selfieInstruction.textContent='Please take a selfie to continue.';
  }

  function submitSelfie(){
    if (state.selfieStage!=='captured') return;
    state.selfieStage='completed';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Selfie submitted.';
    els.entryMsg.style.display='block';         // "Please Come IN"
    stopVideoStream();                          // privacy
    setStep('Step 4: Entry granted – returning soon');
    startResetCountdown();
  }

  /******** Step 4 Reset ********/
  function startResetCountdown(){
    clearResetTimers();
    state.countdownRemaining = Math.round(AUTO_RESET_MS/1000);
    els.resetCountdown.style.display='block';
    updateCountdown();
    state.countdownTimer = setInterval(()=>{
      state.countdownRemaining--;
      if (state.countdownRemaining<=0){
        resetAll();
      } else updateCountdown();
    },1000);
    state.resetTimer = setTimeout(resetAll, AUTO_RESET_MS);
  }

  function updateCountdown(){
    els.resetCountdown.innerHTML = `Step 4: Resetting in ${state.countdownRemaining}s... <a class="inline-reset" id="resetNowLink">(Reset Now)</a>`;
    const link=document.getElementById('resetNowLink');
    if (link) link.onclick = e => { e.preventDefault(); resetAll(); };
  }

  function clearResetTimers(){
    if (state.resetTimer) clearTimeout(state.resetTimer);
    if (state.countdownTimer) clearInterval(state.countdownTimer);
    state.resetTimer=state.countdownTimer=null;
  }

  /******** Utilities ********/
  function hideScannerUI(){
    els.shell.classList.add('hidden');
    els.startBtn.classList.add('hidden');
  }
  function showScannerUI(){
    els.shell.classList.remove('hidden');
    els.startBtn.classList.remove('hidden');
  }

  function stopVideoStream(){
    if (state.stream){
      state.stream.getTracks().forEach(t=>t.stop());
      state.stream=null;
    }
    els.video.srcObject=null;
    els.video.style.display='none';
  }

  function highlight(location){
    const ctx=els.canvas.getContext('2d');
    ctx.clearRect(0,0,els.canvas.width,els.canvas.height);
    if (!location){ flashCanvas(); return; }
    ctx.save();
    ctx.strokeStyle='#16a34a'; ctx.lineWidth=3;
    const pts=[location.topLeftCorner,location.topRightCorner,location.bottomRightCorner,location.bottomLeftCorner];
    if (pts.every(Boolean)){
      ctx.beginPath();
      pts.forEach((p,i)=> i? ctx.lineTo(p.x,p.y): ctx.moveTo(p.x,p.y));
      ctx.closePath(); ctx.stroke();
    }
    ctx.restore();
    flashCanvas();
  }
  function flashCanvas(){ els.canvas.style.opacity=.9; setTimeout(()=>els.canvas.style.opacity=0,220); }

  function stopCameraIfRunning(){
    if (state.running){
      state.running=false;
      cancelAnimationFrame(state.rafId);
      stopVideoStream();
      setBadge('Stopped','warn');
    }
  }

  function resetAll(){
    clearResetTimers();
    stopCameraIfRunning();
    [els.greetingBox, els.selfieSection].forEach(p=>p.style.display='none');
    els.entryMsg.style.display='none';
    els.selfiePreview.style.display='none';
    els.resetCountdown.style.display='none';
    els.captureBtn.disabled=true;
    els.retakeBtn.disabled=true;
    els.submitSelfieBtn.disabled=true;
    els.selfieInstruction.textContent='Please take a selfie to continue.';
    els.methodIndicator.textContent='';
    els.startBtn.classList.remove('hidden');
    els.startBtn.disabled=false;
    els.placeholder.style.display='flex';
    els.video.style.display='none';

    state.lastValue=null;
    state.selfieStage='idle';
    state.selfieData=null;
    state.running=false;

    showScannerUI();
    setBadge('Idle');
    setStep('Step 1: Ready');
  }

  /******** Events ********/
  els.startBtn.addEventListener('click', startScan);
  els.captureBtn.addEventListener('click', captureSelfie);
  els.retakeBtn.addEventListener('click', retakeSelfie);
  els.submitSelfieBtn.addEventListener('click', submitSelfie);
  document.addEventListener('visibilitychange',()=>{ if (document.hidden) stopCameraIfRunning(); });

  // Init
  initDetector();
  window.__qrState = state; // debug if needed

})();
</script>
</body>
</html>
